<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeTrace Chat - 智能对话助手</title>
    <!-- Markdown解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            /* Updated color tokens to match v0 chat design */
            --background: oklch(1 0 0);
            --foreground: oklch(0.145 0 0);
            --card: oklch(0.985 0 0);
            --card-foreground: oklch(0.145 0 0);
            --popover: oklch(1 0 0);
            --popover-foreground: oklch(0.145 0 0);
            --primary: oklch(0.145 0 0);
            --primary-foreground: oklch(0.985 0 0);
            --secondary: oklch(0.97 0 0);
            --secondary-foreground: oklch(0.145 0 0);
            --muted: oklch(0.97 0 0);
            --muted-foreground: oklch(0.556 0 0);
            --accent: oklch(0.646 0.222 264.376);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.577 0.245 27.325);
            --destructive-foreground: oklch(0.985 0 0);
            --border: oklch(0.922 0 0);
            --input: oklch(0.985 0 0);
            --ring: oklch(0.646 0.222 264.376);
            --radius: 0.625rem;
        }
        
        .dark {
            /* Updated dark mode tokens for better contrast */
            --background: oklch(0.145 0 0);
            --foreground: oklch(0.985 0 0);
            --card: oklch(0.205 0 0);
            --card-foreground: oklch(0.985 0 0);
            --popover: oklch(0.205 0 0);
            --popover-foreground: oklch(0.985 0 0);
            --primary: oklch(0.985 0 0);
            --primary-foreground: oklch(0.145 0 0);
            --secondary: oklch(0.269 0 0);
            --secondary-foreground: oklch(0.985 0 0);
            --muted: oklch(0.269 0 0);
            --muted-foreground: oklch(0.708 0 0);
            --accent: oklch(0.646 0.222 264.376);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.577 0.245 27.325);
            --destructive-foreground: oklch(0.985 0 0);
            --border: oklch(0.269 0 0);
            --input: oklch(0.205 0 0);
            --ring: oklch(0.646 0.222 264.376);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.2s, color 0.2s;
        }
        
        /* Header */
        .header {
            border-bottom: 1px solid var(--border);
            background: var(--background);
            backdrop-filter: blur(8px);
            flex-shrink: 0;
        }
        
        .header-content {
            display: flex;
            height: 3.5rem;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-logo {
            display: flex;
            height: 2rem;
            width: 2rem;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            background: var(--primary);
            color: var(--primary-foreground);
        }
        
        .header-title {
            font-weight: 600;
            color: var(--foreground);
            font-size: 1rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            text-decoration: none;
            gap: 0.5rem;
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--foreground);
            padding: 0.5rem;
        }
        
        .btn-ghost:hover {
            background: var(--accent);
            color: var(--accent-foreground);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--foreground);
            border: 1px solid var(--border);
            padding: 0.375rem 0.75rem;
        }
        
        .btn-outline:hover {
            background: var(--accent);
            color: var(--accent-foreground);
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
            padding: 0.375rem 0.75rem;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-icon {
            height: 2rem;
            width: 2rem;
            padding: 0;
        }
        
        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 3.5rem);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            width: 100%;
            transition: opacity 0.15s ease-in-out;
        }
        
        .chat-messages > * {
            max-width: 64rem;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .welcome-screen {
            display: flex;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .welcome-content {
            text-align: center;
            max-width: 32rem;
            margin-bottom: 1.5rem;
        }
        
        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--foreground);
            margin-bottom: 1.5rem;
            line-height: 1.2;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }
        
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-bottom: 90vh; /* 添加底部空间，确保用户消息能滚动到顶部 */
        }
        
        .message {
            display: flex;
            gap: 0.75rem;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.assistant {
            justify-content: flex-start;
        }
        
        .message-avatar {
            width: 2rem;
            height: 2rem;
            margin-top: 0.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: var(--secondary);
            color: var(--secondary-foreground);
        }
        
        .message.assistant .message-avatar {
            background: var(--accent);
            color: var(--accent-foreground);
        }
        
        .message-card {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: var(--radius);
            word-wrap: break-word;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .message.user .message-card {
            background: var(--primary);
            color: var(--primary-foreground);
        }
        
        .message.assistant .message-card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
        }
        
        .message-content {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .message-time {
            display: none;
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--muted);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--muted-foreground);
            border-radius: 4px;
            opacity: 0.5;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--foreground);
            opacity: 0.7;
        }
        
        /* 聊天区域滚动条 */
        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: var(--muted-foreground) var(--muted);
        }
        
        /* 输入框滚动条 - 隐藏滚动条 */
        .chat-input {
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .chat-input::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        

        
        /* Markdown样式 */
        .message-content h1, .message-content h2, .message-content h3,
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 0.5rem 0;
            font-weight: bold;
        }
        
        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.3rem; }
        .message-content h3 { font-size: 1.1rem; }
        
        .message-content p {
            margin: 0.5rem 0;
            line-height: 1.5;
        }
        
        .message-content ul, .message-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .message-content li {
            margin: 0.25rem 0;
        }
        
        .message-content code {
            background-color: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .message-content pre {
            background-color: #f1f5f9;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        .message-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .message-content strong {
            font-weight: bold;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content a {
            color: #667eea;
            text-decoration: none;
        }
        
        .message-content a:hover {
            text-decoration: underline;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .message-content th, .message-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f9fafb;
            font-weight: bold;
        }
        
        /* Input Area */
        .chat-input-container {
            border-top: 1px solid var(--border);
            background: var(--background);
            padding: 1rem;
            flex-shrink: 0;
        }
        
        .input-wrapper {
            max-width: 64rem;
            margin: 0 auto;
        }
        
        .chat-input-form {
            display: flex;
            gap: 0.5rem;
            align-items: end;
        }
        
        .input-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: end;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            font-size: 0.875rem;
            resize: none;
            min-height: 2.75rem;
            max-height: 7.5rem;
            font-family: inherit;
            background: var(--input);
            color: var(--foreground);
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px var(--ring);
        }
        
        .chat-input::placeholder {
            color: var(--muted-foreground);
        }
        
        .send-button {
            height: 2.75rem;
            width: 2.75rem;
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            background: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        

        
        /* 改进的思考状态样式 */
        .thinking-indicator {
            display: none;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            margin: 0.5rem 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease-out;
            max-width: 80%;
        }
        
        .thinking-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .thinking-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            color: var(--accent-foreground);
            flex-shrink: 0;
            position: relative;
        }
        
        .thinking-avatar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: var(--accent);
            opacity: 0.3;
            animation: pulse-ring 2s ease-out infinite;
        }
        
        .thinking-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }
        
        .thinking-text {
            color: var(--muted-foreground);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .thinking-dots {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .thinking-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse-dot 1.4s ease-in-out infinite both;
        }
        
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.1;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }
        
        @keyframes pulse-dot {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.4;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* 保持原有的loading类以兼容性 */
        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--muted-foreground);
            font-style: italic;
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 2rem;
            font-style: italic;
        }
        
        .error-message {
            background: #fee;
            color: #c53030;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border: 1px solid #fed7d7;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .chat-container {
                padding: 0 0.5rem;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <i data-lucide="bot"></i>
                </div>
                <span class="header-title">LifeTrace Chat</span>
            </div>
            <div class="header-right">
                <button class="btn btn-ghost btn-icon" id="newChatBtn" title="开始新对话">
                    <i data-lucide="plus"></i>
                </button>
                <button class="btn btn-ghost btn-icon" id="themeToggle">
                    <i data-lucide="moon" id="themeIcon"></i>
                </button>
                <a href="/analytics" class="btn btn-ghost btn-icon" title="用户行为分析">
                    <i data-lucide="bar-chart-3"></i>
                </a>
                <a href="/chat/settings" class="btn btn-ghost btn-icon" title="设置">
                    <i data-lucide="settings"></i>
                </a>
                <a href="/" class="btn btn-outline">首页</a>
                <a href="/api/docs" class="btn btn-primary">API文档</a>
            </div>
        </div>
    </header>
    
    <!-- Main Chat Area -->
    <main class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <h1 class="welcome-title">我可以帮您做什么？</h1>
                    <div class="quick-actions">
                        <button class="btn btn-outline" onclick="insertQuickQuery('查询今天的截图记录')">
                            <i data-lucide="plus"></i>
                            查询截图记录
                        </button>
                        <button class="btn btn-outline" onclick="insertQuickQuery('分析我的应用使用情况')">
                            <i data-lucide="brain"></i>
                            应用分析
                        </button>
                        <button class="btn btn-outline" onclick="insertQuickQuery('搜索包含特定内容的截图')">
                            <i data-lucide="search"></i>
                            内容搜索
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages List -->
            <div class="messages-list" id="messagesList" style="display: none;"></div>
        </div>
        
        <div class="thinking-indicator" id="thinkingIndicator">
            <div class="thinking-avatar">
                <i data-lucide="bot"></i>
            </div>
            <div class="thinking-content">
                <div class="thinking-text" id="thinkingText">正在思考</div>
                <div class="thinking-dots">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>
        
        <!-- 保持原有的loading指示器以兼容性 -->
        <div class="loading" id="loadingIndicator">
            <div class="message-avatar" style="background: var(--accent); color: var(--accent-foreground);">
                <i data-lucide="bot"></i>
            </div>
            <span>正在思考<span class="loading-dots"></span></span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <form class="chat-input-form" id="chatForm">
                    <div class="input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="询问 LifeTrace 助手..." 
                            rows="1"
                            required
                        ></textarea>
                        <button type="submit" class="send-button" id="sendButton">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>
                                <path d="m21.854 2.147-10.94 10.939"></path>
                            </svg>
                        </button>
                    </div>
                </form>
                

            </div>
        </div>
    </main>
    
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const thinkingIndicator = document.getElementById('thinkingIndicator');
        const thinkingText = document.getElementById('thinkingText');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const messagesList = document.getElementById('messagesList');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        // 思考状态控制函数
        function showThinking(text = '正在思考') {
            thinkingText.textContent = text;
            thinkingIndicator.style.display = 'flex';
            // 使用requestAnimationFrame确保DOM更新后再添加show类
            requestAnimationFrame(() => {
                thinkingIndicator.classList.add('show');
            });
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function hideThinking() {
            thinkingIndicator.classList.remove('show');
            // 等待动画完成后隐藏元素
            setTimeout(() => {
                if (!thinkingIndicator.classList.contains('show')) {
                    thinkingIndicator.style.display = 'none';
                }
            }, 300);
        }
        
        // 轻量级会话上下文：设置与历史存储键
        const SETTINGS_KEY = 'lifetrace_chat_settings';
        const HISTORY_KEY = 'lifetrace_chat_history';

        // 加载设置
        function loadSettings() {
            try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; } catch { return {}; }
        }
        function getSetting(key, defVal) {
            const s = loadSettings();
            return (s && s[key] !== undefined) ? s[key] : defVal;
        }

        // 历史读写
        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch { return []; }
        }
        function saveHistory(history) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }
        function pushHistory(role, content) {
            const h = loadHistory();
            h.push({ role, content, time: Date.now() });
            // 限制最大保存条数，防止无限增长（软上限）
            const maxSaved = 200;
            if (h.length > maxSaved) h.splice(0, h.length - maxSaved);
            saveHistory(h);
        }
        function clearHistory() {
            localStorage.removeItem(HISTORY_KEY);
        }
        function clearHistoryUI() {
            messagesList.innerHTML = '';
            welcomeScreen.style.display = '';
            messagesList.style.display = 'none';
            chatMessages.scrollTop = 0;
        }

        // 构建带K条历史的提示
        function buildPromptWithHistory(currentMessage) {
            const enabled = getSetting('localHistory', true);
            if (!enabled) return currentMessage;
            const K = getSetting('historyLimit', 6); // 若未在设置中配置，则默认6条
            const history = loadHistory();
            if (!history.length) return currentMessage;
            const tail = history.slice(-K);
            const ctx = tail.map(m => `${m.role === 'user' ? '用户' : '助手'}: ${m.content}`).join('\n');
            return `【对话上下文】\n${ctx}\n\n【当前问题】\n用户: ${currentMessage}\n\n请仅回答【当前问题】，必要时参考【对话上下文】。`;
        }
        
        // 处理截图ID链接
        function processScreenshotLinks(content) {
            // 匹配 [截图ID: 数字-数字] 格式（范围）
            const rangePattern = /\[截图ID:\s*(\d+)-(\d+)\]/g;
            content = content.replace(rangePattern, function(match, startId, endId) {
                const start = parseInt(startId);
                const end = parseInt(endId);
                const ids = [];
                for (let i = start; i <= end; i++) {
                    ids.push(i);
                }
                const thumbnails = ids.map(id => 
                    `<div class="screenshot-thumbnail" style="display: inline-block; margin: 2px; padding: 4px 8px; background: #f0f8ff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer; transition: all 0.2s; min-width: 50px; max-width: 80px; text-align: center;" onclick="openScreenshotModal(${id})" onmouseover="this.style.background='#e6f3ff'" onmouseout="this.style.background='#f0f8ff'">
                        <i data-lucide="image" style="width: 12px; height: 12px; margin-right: 3px; vertical-align: middle;"></i>
                        <span style="color: #0066cc; font-size: 12px; vertical-align: middle;">${id}</span>
                    </div>`
                ).join('');
                return `<div class="screenshot-gallery" style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
                    <div style="margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #333;">截图范围 ${startId}-${endId}:</div>
                    ${thumbnails}
                </div>`;
            });
            
            // 匹配 [截图ID: 数字] 格式（单个）
            const singlePattern = /\[截图ID:\s*(\d+)\]/g;
            content = content.replace(singlePattern, function(match, screenshotId) {
                return `<div class="screenshot-thumbnail" style="display: inline-block; margin: 3px; padding: 5px 10px; background: #f0f8ff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer; transition: all 0.2s; min-width: 60px; max-width: 100px; text-align: center;" onclick="openScreenshotModal(${screenshotId})" onmouseover="this.style.background='#e6f3ff'" onmouseout="this.style.background='#f0f8ff'">
                    <i data-lucide="image" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"></i>
                    <span style="color: #0066cc; font-size: 13px; vertical-align: middle;">截图 ${screenshotId}</span>
                </div>`;
            });
            
            // 匹配 [截图ID: 数字, 数字, 数字] 格式（多个）
            const multiplePattern = /\[截图ID:\s*([\d,\s]+)\]/g;
            content = content.replace(multiplePattern, function(match, screenshotIds) {
                const ids = screenshotIds.split(',').map(id => id.trim()).filter(id => id);
                const thumbnails = ids.map(id => 
                    `<div class="screenshot-thumbnail" style="display: inline-block; margin: 2px; padding: 4px 8px; background: #f0f8ff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer; transition: all 0.2s; min-width: 50px; max-width: 80px; text-align: center;" onclick="openScreenshotModal(${id})" onmouseover="this.style.background='#e6f3ff'" onmouseout="this.style.background='#f0f8ff'">
                        <i data-lucide="image" style="width: 12px; height: 12px; margin-right: 3px; vertical-align: middle;"></i>
                        <span style="color: #0066cc; font-size: 12px; vertical-align: middle;">${id}</span>
                    </div>`
                ).join('');
                return `<div class="screenshot-gallery" style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
                    <div style="margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #333;">相关截图:</div>
                    ${thumbnails}
                </div>`;
            });
            
            return content;
        }
        

        
        // 初始化图标
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            // 按设置恢复主题
            const s = loadSettings();
            const shouldDark = !!s.darkMode;
            if (shouldDark) {
                document.documentElement.classList.add('dark');
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', 'sun');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        });
        
        // 主题切换
        let isDark = false;
        themeToggle.addEventListener('click', function() {
            isDark = !isDark;
            document.documentElement.classList.toggle('dark', isDark);
            
            // 更新图标
            themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        // 快速查询功能
        function insertQuickQuery(query) {
            chatInput.value = query;
            chatInput.focus();
        }
        
        // 自动调整输入框高度
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // 支持Enter发送（不需要Ctrl）
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // 添加消息到聊天界面
        function addMessage(content, isUser = false, timestamp = null) {
            // 隐藏欢迎屏幕，显示消息列表
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            // 对于AI回复，检测并渲染Markdown
            let processedContent = content;
            if (!isUser && typeof marked !== 'undefined') {
                // 检测是否包含Markdown语法
                const hasMarkdown = /[#*`_\[\]\(\)\-\+]|\n\n/.test(content);
                if (hasMarkdown) {
                    processedContent = marked.parse(content);
                }
            }
            
            // 处理截图ID链接（仅对AI回复）
            if (!isUser) {
                processedContent = processScreenshotLinks(processedContent);
            }
            
            const avatarContent = isUser ? 'U' : '<i data-lucide="bot"></i>';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-card">
                    <div class="message-content">${processedContent}</div>
                </div>
            `;
            
            messagesList.appendChild(messageDiv);
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 不再自动滚动到底部，保持用户消息居中显示
        }
        
        // 显示错误消息
        function showError(message) {
            // 隐藏欢迎屏幕，显示消息列表
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message assistant';
            errorDiv.innerHTML = `
                <div class="message-avatar" style="background: var(--destructive); color: var(--destructive-foreground);">
                    <i data-lucide="alert-circle"></i>
                </div>
                <div class="message-card" style="border-color: var(--destructive); background: var(--destructive); color: var(--destructive-foreground);">
                    <div class="message-content">${message}</div>
                </div>
            `;
            
            messagesList.appendChild(errorDiv);
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 错误消息不自动滚动，保持当前位置
        }
        
        // 处理表单提交（流式版本）
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            // 添加用户消息到UI与本地历史
            addMessage(message, true);
            pushHistory('user', message);
            
            // 滚动到用户消息位置，让用户消息上边缘贴住聊天区域的可见区域上边缘
            setTimeout(() => {
                const userMessages = messagesList.querySelectorAll('.message.user');
                if (userMessages.length > 0) {
                    const lastUserMessage = userMessages[userMessages.length - 1];
                    // 直接控制chat-messages容器的滚动位置
                    const chatMessagesContainer = document.querySelector('.chat-messages');
                    // 获取用户消息相对于滚动容器的位置
                    const containerRect = chatMessagesContainer.getBoundingClientRect();
                    const messageRect = lastUserMessage.getBoundingClientRect();
                    const currentScrollTop = chatMessagesContainer.scrollTop;
                    const targetScrollTop = currentScrollTop + (messageRect.top - containerRect.top) - 10;
                    
                    chatMessagesContainer.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }, 100); // 增加延迟确保DOM完全更新
            
            // 清空输入框并禁用
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendButton.disabled = true;
            
            // 使用新的思考指示器
            showThinking('正在分析您的问题');
            
            // 保持原有的loading指示器以兼容性（隐藏状态）
            loadingIndicator.style.display = 'none';
            
            // 组装带有最近K条历史的提示
            const payloadMessage = buildPromptWithHistory(message);
            
            // 创建AI消息容器
            let aiMessageDiv = null;
            let aiContentDiv = null;
            let fullResponse = '';
            
            function createAIMessage() {
                // 隐藏欢迎屏幕，显示消息列表
                if (welcomeScreen.style.display !== 'none') {
                    welcomeScreen.style.display = 'none';
                    messagesList.style.display = 'flex';
                }
                
                aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message assistant';
                
                aiMessageDiv.innerHTML = `
                    <div class="message-avatar"><i data-lucide="bot"></i></div>
                    <div class="message-card">
                        <div class="message-content"></div>
                    </div>
                `;
                
                messagesList.appendChild(aiMessageDiv);
                aiContentDiv = aiMessageDiv.querySelector('.message-content');
                
                // 重新创建图标
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            
            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: payloadMessage })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 创建AI消息容器
                createAIMessage();
                
                // 更新思考状态为正在生成回复
                showThinking('正在生成回复');
                
                // 读取流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // 第一次接收到数据时隐藏思考指示器
                    if (fullResponse === '') {
                        hideThinking();
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    fullResponse += chunk;
                    
                    // 实时更新显示内容
                    if (aiContentDiv) {
                        // 检测并渲染Markdown
                        let processedContent = fullResponse;
                        if (typeof marked !== 'undefined') {
                            const hasMarkdown = /[#*`_\[\]\(\)\-\+]|\n\n/.test(fullResponse);
                            if (hasMarkdown) {
                                processedContent = marked.parse(fullResponse);
                            }
                        }
                        aiContentDiv.innerHTML = processedContent;
                        
                        // AI回复完成后不自动滚动，保持用户消息居中
                    }
                }
                
                // 流式输出结束后，重新处理截图链接
                if (aiContentDiv && fullResponse) {
                    // 重新处理截图链接
                    const processedContent = processScreenshotLinks(fullResponse);
                    
                    // 检测并渲染Markdown
                    let finalContent = processedContent;
                    if (typeof marked !== 'undefined') {
                        const hasMarkdown = /[#*`_\[\]\(\)\-\+]|\n\n/.test(processedContent);
                        if (hasMarkdown) {
                            finalContent = marked.parse(processedContent);
                        }
                    }
                    
                    aiContentDiv.innerHTML = finalContent;
                    
                    // 重新创建图标
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
                
                // 保存完整回复到历史
                if (fullResponse) {
                    pushHistory('assistant', fullResponse);
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                hideThinking(); // 确保在错误时隐藏思考指示器
                showError('抱歉，发生了错误：' + error.message);
            } finally {
                sendButton.disabled = false;
                hideThinking(); // 确保思考指示器被隐藏
                loadingIndicator.style.display = 'none';
                chatInput.focus();
            }
        });
        
        // 新对话按钮功能
        const newChatBtn = document.getElementById('newChatBtn');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', async function() {
                try {
                    // 调用后端API创建新对话
                    const response = await fetch('/api/chat/new', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('新对话创建成功:', result);
                        
                        // 清除本地历史记录
                        clearHistory();
                        
                        // 重置界面状态
                        clearHistoryUI();
                        
                        // 聚焦输入框
                        chatInput.focus();
                        
                        // 添加平滑过渡效果
                        messagesList.style.opacity = '0';
                        setTimeout(() => {
                            messagesList.style.opacity = '1';
                        }, 150);
                        
                        // 可选：显示成功提示
                        // showMessage('新对话已开始', 'success');
                    } else {
                        console.error('创建新对话失败:', response.statusText);
                        showError('创建新对话失败，请稍后重试');
                    }
                } catch (error) {
                    console.error('创建新对话时发生错误:', error);
                    showError('创建新对话时发生错误：' + error.message);
                }
            });
        }

        // 页面加载完成后：回放历史并聚焦输入框
        window.addEventListener('load', function() {
            // 回放历史
            const history = loadHistory();
            if (history.length) {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
                history.forEach(m => {
                    addMessage(m.content, m.role === 'user');
                });
            }
            chatInput.focus();
        });

        // 监听来自设置页的清除历史操作
        window.addEventListener('storage', (e) => {
            if (e.key === HISTORY_KEY) {
                if (!e.newValue || e.newValue === '[]') {
                    clearHistoryUI();
                }
            }
            if (e.key === SETTINGS_KEY) {
                // 立即应用暗色模式变更
                try {
                    const s = JSON.parse(e.newValue || '{}');
                    const dm = !!(s && s.darkMode);
                    document.documentElement.classList.toggle('dark', dm);
                    if (themeIcon) {
                        themeIcon.setAttribute('data-lucide', dm ? 'sun' : 'moon');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                } catch {}
            }
        });

        // 截图预览功能
        let currentScreenshotId = null;
        let availableScreenshotIds = [];
        
        function openScreenshotModal(screenshotId) {
            const modal = document.getElementById('screenshotModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalImage = document.getElementById('modalImage');
            const modalLoading = document.getElementById('modalLoading');
            const modalError = document.getElementById('modalError');
            
            // 设置当前截图ID
            currentScreenshotId = parseInt(screenshotId);
            
            // 获取所有可用的截图ID
            updateAvailableScreenshotIds();
            
            // 显示弹窗
            modal.style.display = 'block';
            modalTitle.textContent = `截图 ${screenshotId}`;
            
            // 更新导航按钮状态
            updateNavigationButtons();
            
            // 显示加载状态
            modalLoading.style.display = 'block';
            modalImage.style.display = 'none';
            modalError.style.display = 'none';
            
            // 加载图片
            loadScreenshotImage(screenshotId);
        }
        
        function loadScreenshotImage(screenshotId) {
            const modalImage = document.getElementById('modalImage');
            const modalLoading = document.getElementById('modalLoading');
            const modalError = document.getElementById('modalError');
            const modalTime = document.getElementById('modalTime');
            
            // 显示加载状态
            modalLoading.style.display = 'block';
            modalImage.style.display = 'none';
            modalError.style.display = 'none';
            modalTime.textContent = '';
            
            // 获取截图详细信息
            fetch(`/api/screenshots/${screenshotId}`)
                .then(response => response.json())
                .then(data => {
                    // 更新时间显示
                    if (data.created_at) {
                        const time = new Date(data.created_at).toLocaleString('zh-CN');
                        modalTime.textContent = time;
                    }
                })
                .catch(error => {
                    console.error('获取截图信息失败:', error);
                });
            
            const img = new Image();
            img.onload = function() {
                modalImage.src = this.src;
                modalLoading.style.display = 'none';
                modalImage.style.display = 'block';
                modalError.style.display = 'none';
                // 重新创建图标
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            };
            img.onerror = function() {
                modalLoading.style.display = 'none';
                modalError.style.display = 'block';
                modalImage.style.display = 'none';
                // 重新创建图标
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            };
            img.src = `/api/screenshots/${screenshotId}/image`;
        }
        
        function updateAvailableScreenshotIds() {
            // 从页面中提取所有截图ID，并获取完整范围
            const screenshotElements = document.querySelectorAll('.screenshot-thumbnail');
            const ids = new Set();
            
            screenshotElements.forEach(element => {
                const onclick = element.getAttribute('onclick');
                if (onclick) {
                    const match = onclick.match(/openScreenshotModal\((\d+)\)/);
                    if (match) {
                        ids.add(parseInt(match[1]));
                    }
                }
            });
            
            // 如果有截图ID，创建从0到最大ID的完整范围
            if (ids.size > 0) {
                const maxId = Math.max(...Array.from(ids));
                availableScreenshotIds = [];
                for (let i = 0; i <= maxId; i++) {
                    availableScreenshotIds.push(i);
                }
            } else {
                availableScreenshotIds = [];
            }
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevScreenshotBtn');
            const nextBtn = document.getElementById('nextScreenshotBtn');
            
            if (!prevBtn || !nextBtn) return;
            
            const currentIndex = availableScreenshotIds.indexOf(currentScreenshotId);
            
            // 更新按钮状态
            prevBtn.style.opacity = currentIndex > 0 ? '1' : '0.3';
            prevBtn.style.cursor = currentIndex > 0 ? 'pointer' : 'not-allowed';
            
            nextBtn.style.opacity = currentIndex < availableScreenshotIds.length - 1 ? '1' : '0.3';
            nextBtn.style.cursor = currentIndex < availableScreenshotIds.length - 1 ? 'pointer' : 'not-allowed';
        }
        
        function navigateScreenshot(direction) {
            const currentIndex = availableScreenshotIds.indexOf(currentScreenshotId);
            let newIndex;
            
            if (direction === 'prev' && currentIndex > 0) {
                newIndex = currentIndex - 1;
            } else if (direction === 'next' && currentIndex < availableScreenshotIds.length - 1) {
                newIndex = currentIndex + 1;
            } else {
                return; // 无法导航
            }
            
            const newScreenshotId = availableScreenshotIds[newIndex];
            currentScreenshotId = newScreenshotId;
            
            // 更新标题
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.textContent = `截图 ${newScreenshotId}`;
            
            // 更新导航按钮状态
            updateNavigationButtons();
            
            // 加载新图片
            loadScreenshotImage(newScreenshotId);
        }
        
        function closeScreenshotModal() {
            const modal = document.getElementById('screenshotModal');
            modal.style.display = 'none';
            currentScreenshotId = null;
            availableScreenshotIds = [];
        }
        
        // 点击弹窗外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('screenshotModal');
            if (event.target === modal) {
                closeScreenshotModal();
            }
        }
        
        // ESC键关闭弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeScreenshotModal();
            } else if (event.key === 'ArrowLeft') {
                navigateScreenshot('prev');
            } else if (event.key === 'ArrowRight') {
                navigateScreenshot('next');
            }
        });
    </script>

    <!-- 截图预览弹窗 -->
    <div id="screenshotModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="position: relative; margin: 2% auto; padding: 0; width: 95%; max-width: 1200px; background-color: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div class="modal-header" style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h3 id="modalTitle" style="margin: 0; color: #333; font-size: 18px;">截图预览</h3>
                    <span id="modalTime" style="color: #666; font-size: 14px; font-weight: normal;"></span>
                </div>
                <span class="close" onclick="closeScreenshotModal()" style="font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1;" onmouseover="this.style.color='#000'" onmouseout="this.style.color='#aaa'">&times;</span>
            </div>
            <div class="modal-body" style="position: relative; padding: 20px; text-align: center;">
                <!-- 左侧导航按钮 -->
                <button id="prevScreenshotBtn" onclick="navigateScreenshot('prev')" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='rgba(0,0,0,0.7)'" onmouseout="this.style.background='rgba(0,0,0,0.5)'">
                    <i data-lucide="chevron-left" style="width: 22px; height: 22px;"></i>
                </button>
                
                <!-- 右侧导航按钮 -->
                <button id="nextScreenshotBtn" onclick="navigateScreenshot('next')" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='rgba(0,0,0,0.7)'" onmouseout="this.style.background='rgba(0,0,0,0.5)'">
                    <i data-lucide="chevron-right" style="width: 22px; height: 22px;"></i>
                </button>
                
                <div id="modalLoading" style="display: none; color: #666; font-size: 16px; padding: 40px;">
                    <i data-lucide="loader-2" style="width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; animation: spin 1s linear infinite;"></i>
                    加载中...
                </div>
                <img id="modalImage" style="max-width: 100%; max-height: 80vh; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);" />
                <div id="modalError" style="display: none; color: #e74c3c; font-size: 16px; padding: 40px;">
                    <i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-right: 8px; vertical-align: middle;"></i>
                    图像加载失败
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>

</body>
</html>