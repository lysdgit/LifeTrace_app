<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeTrace Chat</title>
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <!-- Markdown解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            /* Updated color tokens to match v0 chat design */
            --background: oklch(1 0 0);
            --foreground: oklch(0.145 0 0);
            --card: oklch(0.985 0 0);
            --card-foreground: oklch(0.145 0 0);
            --popover: oklch(1 0 0);
            --popover-foreground: oklch(0.145 0 0);
            --primary: oklch(0.145 0 0);
            --primary-foreground: oklch(0.985 0 0);
            --secondary: oklch(0.97 0 0);
            --secondary-foreground: oklch(0.145 0 0);
            --muted: oklch(0.97 0 0);
            --muted-foreground: oklch(0.556 0 0);
            --accent: oklch(0.646 0.222 264.376);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.577 0.245 27.325);
            --destructive-foreground: oklch(0.985 0 0);
            --border: oklch(0.922 0 0);
            --input: oklch(0.985 0 0);
            --ring: oklch(0.646 0.222 264.376);
            --radius: 0.625rem;
        }
        
        .dark {
            /* Updated dark mode tokens for better contrast */
            --background: oklch(0.145 0 0);
            --foreground: oklch(0.985 0 0);
            --card: oklch(0.205 0 0);
            --card-foreground: oklch(0.985 0 0);
            --popover: oklch(0.205 0 0);
            --popover-foreground: oklch(0.985 0 0);
            --primary: oklch(0.985 0 0);
            --primary-foreground: oklch(0.145 0 0);
            --secondary: oklch(0.269 0 0);
            --secondary-foreground: oklch(0.985 0 0);
            --muted: oklch(0.269 0 0);
            --muted-foreground: oklch(0.708 0 0);
            --accent: oklch(0.646 0.222 264.376);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.577 0.245 27.325);
            --destructive-foreground: oklch(0.985 0 0);
            --border: oklch(0.269 0 0);
            --input: oklch(0.205 0 0);
            --ring: oklch(0.646 0.222 264.376);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.2s, color 0.2s;
        }
        
        /* 全局顶部标题栏 */
        .global-header {
            flex-shrink: 0;
            width: 100%;
            z-index: 50;
        }
        
        /* 主容器布局 - 三列结构 */
        .main-layout {
            display: flex;
            flex: 1;
            width: 100%;
            min-height: 0;
        }
        
        /* 左侧图标导航栏 */
        .sidebar-nav {
            width: 60px;
            flex-shrink: 0;
            background-color: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            gap: 0.5rem;
            overflow-y: auto;
        }
        
        /* 图标按钮样式 */
        .nav-icon-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--muted-foreground);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .nav-icon-btn:hover {
            background: var(--muted);
            color: var(--foreground);
            transform: scale(1.05);
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .nav-icon-btn.active {
            background: var(--primary);
            color: var(--primary-foreground);
        }
        
        .nav-icon-btn.active::after {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--primary);
            border-radius: 0 2px 2px 0;
        }
        
        /* 中间内容区域 */
        .middle-content-area {
            flex: 0;
            background-color: var(--background);
            border-right: 1px solid var(--border);
            overflow: hidden;
            transition: flex 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
            min-width: 0;
        }
        
        .middle-content-area.expanded {
            flex: 7;
        }
        
        /* 关闭面板按钮 - 已禁用 */
        .close-panel-btn {
            display: none;
        }
        
        /* 内容面板 */
        .content-panel {
            display: none;
            flex: 1;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.2s ease;
            /* 应用与忆往昔相同的滚动条样式 */
            scrollbar-width: thin;
            scrollbar-color: rgba(107, 114, 128, 0.3) rgba(243, 244, 246, 0.5);
        }
        
        /* 中间内容区滚动条样式 - Webkit浏览器 */
        .content-panel::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        .content-panel::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .content-panel::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.2);
            border-radius: 3px;
        }
        
        .content-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.4);
        }
        
        .content-panel.active {
            display: flex;
            flex-direction: column;
            opacity: 1;
        }
        
        /* 右侧聊天区域 */
        .chat-area {
            flex: 3;
            display: flex;
            flex-direction: column;
            background-color: var(--card);
            min-width: 0;
            transition: flex 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 当中间内容区展开时，聊天区域占30% */
        .middle-content-area.expanded ~ .chat-area {
            flex: 3;
        }
        
        /* 保留原有的left-area和right-chat-area类作为兼容（已废弃） */
        .left-area {
            display: none;
        }
        
        .right-chat-area {
            display: none;
        }
        
        /* Header */
        .header {
            border-bottom: 1px solid var(--border);
            background: var(--background);
            backdrop-filter: blur(8px);
            flex-shrink: 0;
        }
        
        .header-content {
            display: flex;
            height: 3.5rem;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-logo {
            display: flex;
            height: 2rem;
            width: 2rem;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            background: var(--primary);
            color: var(--primary-foreground);
        }
        
        .header-title {
            font-weight: 600;
            color: var(--foreground);
            font-size: 1rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            text-decoration: none;
            gap: 0.5rem;
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--foreground);
            padding: 0.5rem;
        }
        
        .btn-ghost:hover {
            background: var(--muted);
            color: var(--foreground);
            transform: translateY(-1px);
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--foreground);
            border: 1px solid var(--border);
            padding: 0.375rem 0.75rem;
        }
        
        .btn-outline:hover {
            background: var(--muted);
            border-color: var(--foreground);
            color: var(--foreground);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
            padding: 0.375rem 0.75rem;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-icon {
            height: 2rem;
            width: 2rem;
            padding: 0;
        }
        
        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            width: 100%;
            transition: opacity 0.15s ease-in-out;
        }
        
        .chat-messages > * {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .welcome-screen {
            display: flex;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .welcome-content {
            text-align: center;
            max-width: 100%;
            margin-bottom: 1.5rem;
        }
        
        .welcome-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--foreground);
            margin-bottom: 1.5rem;
            line-height: 1.2;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }
        
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-bottom: 90vh; /* 添加底部空间，确保用户消息能滚动到顶部 */
        }
        
        .message {
            display: flex;
            gap: 0.75rem;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.assistant {
            justify-content: flex-start;
        }
        
        .message-avatar {
            width: 2rem;
            height: 2rem;
            margin-top: 0.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: var(--secondary);
            color: var(--secondary-foreground);
        }
        
        .message.assistant .message-avatar {
            background: transparent;
            color: var(--muted-foreground);
        }
        
        .message-card {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: var(--radius);
            word-wrap: break-word;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .message.user .message-card {
            background: var(--primary);
            color: var(--primary-foreground);
        }
        
        .message.assistant .message-card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
        }
        
        .message-content {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .message-time {
            display: none;
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--muted);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--muted-foreground);
            border-radius: 4px;
            opacity: 0.5;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--foreground);
            opacity: 0.7;
        }
        
        /* 聊天区域滚动条 */
        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: var(--muted-foreground) var(--muted);
        }
        
        /* 输入框滚动条 - 隐藏滚动条 */
        .chat-input {
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .chat-input::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        

        
        /* Markdown样式 */
        .message-content h1, .message-content h2, .message-content h3,
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 0.5rem 0;
            font-weight: bold;
        }
        
        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.3rem; }
        .message-content h3 { font-size: 1.1rem; }
        
        .message-content p {
            margin: 0.5rem 0;
            line-height: 1.5;
        }
        
        .message-content ul, .message-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .message-content li {
            margin: 0.25rem 0;
        }
        
        .message-content code {
            background-color: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .message-content pre {
            background-color: #f1f5f9;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        .message-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .message-content strong {
            font-weight: bold;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content a {
            color: #667eea;
            text-decoration: none;
        }
        
        .message-content a:hover {
            text-decoration: underline;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .message-content th, .message-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f9fafb;
            font-weight: bold;
        }
        
        /* Input Area */
        .chat-input-container {
            border-top: 1px solid var(--border);
            background: var(--background);
            padding: 1rem;
            flex-shrink: 0;
        }
        
        .input-wrapper {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .chat-input-form {
            display: flex;
            gap: 0.5rem;
            align-items: end;
        }
        
        .input-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: end;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            font-size: 0.875rem;
            resize: none;
            min-height: 2.75rem;
            max-height: 7.5rem;
            font-family: inherit;
            background: var(--input);
            color: var(--foreground);
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px var(--ring);
        }
        
        .chat-input::placeholder {
            color: var(--muted-foreground);
        }
        
        .send-button {
            height: 2.75rem;
            width: 2.75rem;
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            background: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        

        
        /* 改进的思考状态样式 - 整合到消息流中 */
        .thinking-message {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-start;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .thinking-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .thinking-message .message-card {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: var(--radius);
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
        }
        
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .thinking-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            color: var(--accent-foreground);
            flex-shrink: 0;
            position: relative;
        }
        
        .thinking-avatar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: var(--accent);
            opacity: 0.3;
            animation: pulse-ring 2s ease-out infinite;
        }
        
        .thinking-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }
        
        .thinking-text {
            color: var(--muted-foreground);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .thinking-dots {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .thinking-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse-dot 1.4s ease-in-out infinite both;
        }
        
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.1;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }
        
        @keyframes pulse-dot {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.4;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* 保持原有的loading类以兼容性 */
        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--muted-foreground);
            font-style: italic;
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 2rem;
            font-style: italic;
        }
        
        .error-message {
            background: #fee;
            color: #c53030;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border: 1px solid #fed7d7;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .chat-container {
                padding: 0 0.5rem;
            }
            
            .message-content {
                max-width: 85%;
            }
        }

        /* Events 样式 */
        .events-container {
            padding: 1rem;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .events-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
            flex-shrink: 0;
        }

        .events-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a5568;
            margin: 0;
        }

        /* 搜索表单样式 */
        .events-search-section {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 1rem;
            box-shadow: none;
            flex-shrink: 0;
        }

        .events-search-form {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }

        .events-form-group {
            display: flex;
            align-items: center;
            position: relative;
            flex-grow: 1;
        }

        .events-form-group:has(input[type="text"]) {
            flex-grow: 0.67;
        }

        .events-form-group:last-child {
            flex: 0 0 auto;
        }

        .events-form-group span {
            margin-right: 0.5rem;
            color: #475569;
            font-size: 0.9rem;
        }

        .events-form-group input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .events-form-group input:focus {
            outline: none;
            border-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.1);
        }

        .events-form-group input:hover {
            border-color: #9ca3af;
        }

        /* 日期输入框特殊样式 */
        .events-form-group input[type="date"] {
            position: relative;
            color: #475569;
            cursor: pointer;
            min-width: 130px;
        }

        .events-form-group input[type="date"]::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat center;
            background-size: 16px 16px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .events-form-group input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* 文本输入框图标 */
        .events-form-group input[type="text"] {
            padding-left: 2.5rem;
            width: 100%;
        }

        .events-form-group .input-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
            transition: color 0.2s ease;
        }

        .events-form-group:focus-within .input-icon {
            color: #475569;
        }
        
        .events-search-icon-btn {
            padding: 0.5rem;
            height: auto;
            line-height: 1;
        }
        
        .events-search-icon-btn .lucide {
            width: 1.125rem;
            height: 1.125rem;
        }

            color: #6b7280;
        }

        .events-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .events-btn-primary {
            background: #667eea;
            color: white;
        }

        .events-btn-primary:hover {
            background: #5a6fd8;
        }

        /* 搜索图标按钮样式 */
        .events-search-icon-btn {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: #6b7280;
            border: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .events-search-icon-btn i {
            width: 1rem;
            height: 1rem;
            color: #fff !important;
        }

        .events-search-icon-btn:hover {
            background: #4b5563;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .events-search-icon-btn:active {
            transform: translateY(1px);
        }

        /* 时间轴样式 - GitHub风格重设计 */
        .events-timeline-section {
            background: #fafbfc;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e1e4e8;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            /* 应用与右侧聊天区域相同的滚动条样式 */
            scrollbar-width: thin;
            scrollbar-color: rgba(107, 114, 128, 0.3) rgba(243, 244, 246, 0.5);
        }

        .events-timeline-section::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .events-timeline-section::-webkit-scrollbar-track {
            background: transparent;
        }

        .events-timeline-section::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.2);
            border-radius: 3px;
        }

        .events-timeline-section::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.4);
        }

        .events-timeline-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e1e4e8;
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin: -1rem -1rem 1rem -1rem;
        }

        .events-timeline-stats {
            color: #586069;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .events-timeline {
            position: relative;
            padding-left: 2rem;
        }

        /* GitHub风格的左侧轴线 */
        .events-timeline::before {
            content: '';
            position: absolute;
            left: 0.76rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e1e4e8;
            display: block;
        }

        /* 日期分组标题 */
        .events-date-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .events-date-header {
            position: relative;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
        }

        .events-date-header::before {
            content: '';
            position: absolute;
            left: -1.54rem;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #586069;
            border-radius: 50%;
            border: 2px solid #fafbfc;
            z-index: 2;
        }

        .events-date-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #24292e;
            margin: 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .events-date-icon {
            width: 16px;
            height: 16px;
            opacity: 0.6;
        }

        .events-timeline-item {
            position: relative;
            margin-bottom: 0.75rem;
            margin-left: 0.5rem;
            background: white;
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid #e1e4e8;
            transition: all 0.15s ease-in-out;
            font-size: 0.875rem;
            box-shadow: none;
        }

        /* 事件项的连接点 */
        .events-timeline-item::before {
            content: '';
            position: absolute;
            left: -1.76rem;
            top: 1rem;
            width: 8px;
            height: 8px;
            background: white;
            border: 2px solid #0366d6;
            border-radius: 50%;
            z-index: 2;
        }

        .events-timeline-item:hover {
            border-color: #c8e1ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            transform: none;
            background: #f6f8fa;
        }

        .events-timeline-item:hover .events-app-name {
            background: #e1f5fe;
            border-color: #0366d6;
            color: #0366d6;
        }

        .events-timeline-item:hover .events-window-title {
            color: #0366d6;
        }

        .events-timeline-item:hover .events-event-duration,
        .events-timeline-item:hover .events-event-status {
            transform: scale(1.02);
        }

        /* 添加微妙的动画效果 */
        .events-app-name,
        .events-window-title,
        .events-event-duration,
        .events-event-status {
            transition: all 0.15s ease-in-out;
        }

        .events-timeline-item::before {
            display: none;
        }

        .events-event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .events-event-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #24292e;
            margin: 0;
            line-height: 1.25;
            flex: 1;
            margin-right: 1rem;
        }

        .events-app-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .events-app-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #0366d6;
            background: #f1f8ff;
            padding: 0.125rem 0.375rem;
            border-radius: 12px;
            border: 1px solid #c8e1ff;
            display: inline-block;
            width: fit-content;
        }

        .events-window-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #24292e;
            line-height: 1.25;
        }

        .events-time-text {
            font-size: 0.75rem;
            color: #586069;
            font-weight: 400;
        }

        .events-event-status {
            font-size: 0.75rem;
            color: #28a745;
            font-weight: 500;
            background: #dcffe4;
            padding: 0.125rem 0.375rem;
            border-radius: 12px;
            border: 1px solid #34d058;
        }

        .events-event-time {
            font-size: 0.75rem;
            color: #586069;
            text-align: right;
            font-weight: 400;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .events-event-duration {
            font-size: 0.75rem;
            color: #28a745;
            font-weight: 500;
            background: #dcffe4;
            padding: 0.125rem 0.375rem;
            border-radius: 12px;
            border: 1px solid #34d058;
        }

        .events-screenshots-preview {
            margin-top: 0.75rem;
        }

        .events-screenshots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .events-screenshot-thumb {
            width: 100%;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            border: 1px solid #e1e4e8;
            box-shadow: none;
        }

        .events-screenshot-thumb:hover {
            transform: scale(1.02);
            border-color: #0366d6;
            box-shadow: 0 1px 3px rgba(3, 102, 214, 0.2);
        }

        .events-loading {
            text-align: center;
            padding: 2rem;
            color: #586069;
            font-size: 0.875rem;
        }

        .events-loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e1e4e8;
            border-top: 2px solid #0366d6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        .events-empty-state {
            text-align: center;
            padding: 2rem;
            color: #586069;
            font-size: 0.875rem;
        }

        .events-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e1e4e8;
        }

        .events-pagination button {
            padding: 0.375rem 0.75rem;
            border: 1px solid #e1e4e8;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            color: #24292e;
            transition: all 0.15s ease-in-out;
        }

        .events-pagination button:hover:not(:disabled) {
            background: #f6f8fa;
            border-color: #d0d7de;
        }

        .events-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #fafbfc;
        }

        /* 标签导航样式 */
        .tab-navigation {
            background: var(--background);
            border-bottom: 1px solid var(--border);
        }

        .tab-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .events-title-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tab-buttons {
            display: flex;
            background: var(--muted);
            border-radius: var(--radius);
            padding: 0.125rem;
            margin: 0.5rem;
            height: 2.5rem;
            align-items: center;
        }

        .tab-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            border: none;
            background: transparent;
            color: var(--muted-foreground);
            border-radius: calc(var(--radius) - 0.125rem);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tab-button:hover {
            background: var(--background);
            color: var(--foreground);
        }

        .tab-button.active {
            background: var(--background);
            color: var(--foreground);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-button i {
            width: 0.875rem;
            height: 0.875rem;
        }

        /* 标签内容区域 */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            /* 应用与右侧聊天区域相同的滚动条样式 */
            scrollbar-width: thin;
            scrollbar-color: var(--muted-foreground) var(--muted);
        }

        .tab-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: var(--muted);
            border-radius: 4px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: var(--muted-foreground);
            border-radius: 4px;
            opacity: 0.5;
        }

        .tab-content::-webkit-scrollbar-thumb:hover {
            background: var(--foreground);
            opacity: 0.7;
        }

        .tab-panel {
            display: none;
            height: 100%;
            overflow-y: auto;
            min-height: 0;
            /* 应用与右侧聊天区域相同的滚动条样式 */
            scrollbar-width: thin;
            scrollbar-color: var(--muted-foreground) var(--muted);
        }

        .tab-panel::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .tab-panel::-webkit-scrollbar-track {
            background: var(--muted);
            border-radius: 4px;
        }

        .tab-panel::-webkit-scrollbar-thumb {
            background: var(--muted-foreground);
            border-radius: 4px;
            opacity: 0.5;
        }

        .tab-panel::-webkit-scrollbar-thumb:hover {
            background: var(--foreground);
            opacity: 0.7;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        .search-content {
            padding: 2rem;
            text-align: center;
            color: var(--muted-foreground);
        }

        .search-content h3 {
            margin-bottom: 1rem;
            color: var(--foreground);
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* 数据分析标签页样式 */
        .analytics-content {
            padding: 1rem;
            height: 100%;
            overflow-y: auto;
        }

        .analytics-content h3 {
            margin-bottom: 1rem;
            color: var(--foreground);
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* App Usage 样式 */
        .app-usage-container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        .app-usage-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--foreground);
        }

        .app-usage-description {
            color: var(--muted-foreground);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .app-usage-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .app-usage-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .app-usage-filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--foreground);
        }

        .app-usage-filter-select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--background);
            color: var(--foreground);
            font-size: 0.875rem;
        }

        .app-usage-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .app-usage-stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 1rem;
        }

        .app-usage-stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .app-usage-stat-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--muted-foreground);
        }

        .app-usage-stat-icon {
            width: 0.875rem;
            height: 0.875rem;
            color: var(--muted-foreground);
        }

        .app-usage-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--foreground);
        }

        .app-usage-stat-change {
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        .app-usage-chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .app-usage-chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--foreground);
        }

        .app-usage-chart-wrapper {
            position: relative;
            height: 250px;
        }

        /* 优化统计卡片样式，使其高度与饼图匹配 */
        .app-usage-stats-vertical .app-usage-stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 1.5rem 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 0;
        }

        .app-usage-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: var(--muted-foreground);
            font-size: 0.875rem;
        }

        .app-usage-error {
            color: var(--destructive);
            text-align: center;
            padding: 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- 全局顶部标题栏 -->
    <header class="header global-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <i data-lucide="bot"></i>
                </div>
                <span class="header-title">LifeTrace Chat</span>
            </div>
            <div class="header-right">
                <button class="btn btn-ghost btn-icon" id="newChatBtn" title="开始新对话">
                    <i data-lucide="plus"></i>
                </button>
                <a href="/chat/settings" class="btn btn-ghost btn-icon" title="设置">
                    <i data-lucide="settings"></i>
                </a>
            </div>
        </div>
    </header>
    
    <!-- 三列主布局 -->
    <div class="main-layout">
        <!-- 左侧图标导航栏 -->
        <aside class="sidebar-nav">
            <button class="nav-icon-btn" data-panel="events" title="忆往昔">
                <i data-lucide="history"></i>
            </button>
            <button class="nav-icon-btn" data-panel="search" title="省吾身">
                <i data-lucide="search-check"></i>
            </button>
            <button class="nav-icon-btn" data-panel="analytics" title="预则立">
                <i data-lucide="target"></i>
            </button>
        </aside>
        
        <!-- 中间内容区域 -->
        <div class="middle-content-area" id="middleContent">
            <!-- 面板内容容器 -->
            <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <!-- 事件时间轴面板 -->
                <div class="content-panel" id="events-content">
                    <!-- Events 事件管理区域 -->
                    <div class="events-container">
                        <!-- 搜索表单 -->
                        <div class="events-search-section">
                    <form id="eventsSearchForm" class="events-search-form">
                        <div class="events-form-group">
                            <span>开始时间</span>
                            <input type="date" id="eventsStartDate" name="startDate">
                        </div>
                        <div class="events-form-group">
                            <span>结束时间</span>
                            <input type="date" id="eventsEndDate" name="endDate">
                        </div>
                        <div class="events-form-group">
                            <div class="input-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            </div>
                            <input type="text" id="appFilter" name="appFilter" placeholder="应用">
                        </div>
                        <div class="events-form-group">
                            <div class="input-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            </div>
                            <input type="text" id="eventsAppName" name="appName" placeholder="关键词">
                        </div>
                        <div class="events-form-group">
                            <button type="submit" class="events-btn events-btn-primary events-search-icon-btn">
                                <i data-lucide="search"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 时间轴区域 -->
                <div class="events-timeline-section">
                    <div class="events-timeline-header">
                        <div class="events-timeline-stats" id="eventsTimelineStats">
                            加载中...
                        </div>
                    </div>
                    
                    <div id="eventsTimelineContainer">
                        <div class="events-loading">正在加载事件数据</div>
                    </div>

                    <!-- 分页 -->
                    <div class="events-pagination" id="eventsPagination" style="display: none;">
                        <button id="eventsPrevPage">上一页</button>
                        <span id="eventsPageInfo">第 1 页</span>
                        <button id="eventsNextPage">下一页</button>
                    </div>
                </div>
                    </div>
                </div>

                <!-- 今日总结面板 -->
                <div class="content-panel" id="search-content">
                    <div class="analytics-content">
                        <div class="app-usage-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h1 class="app-usage-title">今日行为总结</h1>
                                    <p class="app-usage-description">回顾今天的工作和应用使用情况</p>
                                </div>
                                <button id="generateSummaryBtn" class="summary-btn" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    padding: 10px 20px;
                                    font-size: 14px;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                                    <i data-lucide="sparkles" style="width: 16px; height: 16px;"></i>
                                    生成今日总结
                                </button>
                            </div>

                            <!-- 总结内容区域 -->
                            <div id="summaryContent" style="
                                background: #f8fafc;
                                border-radius: 12px;
                                padding: 20px;
                                margin-bottom: 20px;
                                border: 1px solid #e2e8f0;
                                min-height: 120px;
                                display: none;
                            ">
                                <div id="summaryText" style="
                                    line-height: 1.6;
                                    color: #334155;
                                    font-size: 14px;
                                "></div>
                                <div id="summaryLoading" style="
                                    display: none;
                                    text-align: center;
                                    color: #64748b;
                                    padding: 40px;
                                ">
                                    <i data-lucide="loader-2" style="width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; animation: spin 1s linear infinite;"></i>
                                    正在生成今日总结...
                                </div>
                            </div>

                            <!-- 统计卡片和饼图的组合布局 -->
                            <div class="app-usage-main-layout" style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem; align-items: stretch;">
                                <!-- 饼图区域 -->
                                <div class="app-usage-chart-container" style="flex: 1; margin-bottom: 0; display: flex; flex-direction: column;">
                                    <h2 class="app-usage-chart-title">应用使用时长分布</h2>
                                    <div class="app-usage-chart-wrapper" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                        <canvas id="appUsageChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- 统计卡片区域 -->
                                <div class="app-usage-stats-vertical" style="display: flex; flex-direction: column; gap: 1rem; flex: 0 0 300px; justify-content: center;">
                                    <div class="app-usage-stat-card">
                                        <div class="app-usage-stat-header">
                                            <span class="app-usage-stat-title">总使用时长</span>
                                            <i data-lucide="clock" class="app-usage-stat-icon"></i>
                                        </div>
                                        <div class="app-usage-stat-value" id="appUsageTotalTime">-</div>
                                        <div class="app-usage-stat-change">小时</div>
                                    </div>
                                    
                                    <div class="app-usage-stat-card">
                                        <div class="app-usage-stat-header">
                                            <span class="app-usage-stat-title">使用应用数</span>
                                            <i data-lucide="grid-3x3" class="app-usage-stat-icon"></i>
                                        </div>
                                        <div class="app-usage-stat-value" id="appUsageTotalApps">-</div>
                                        <div class="app-usage-stat-change">个应用</div>
                                    </div>
                                </div>
                            </div>

                            <div class="app-usage-chart-container">
                                <h2 class="app-usage-chart-title">小时使用分布</h2>
                                <div class="app-usage-chart-wrapper">
                                    <canvas id="hourlyUsageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据分析面板 -->
                <div class="content-panel" id="analytics-content">
                    <div class="analytics-content">
                        <h3>数据分析</h3>
                        <p>这里将显示数据分析和相关功能</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧AI聊天区域 -->
        <div class="chat-area">
            <!-- Main Chat Area -->
    <main class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <h1 class="welcome-title">我可以帮您做什么？</h1>
                    <div class="quick-actions">
                        <button class="btn btn-outline" onclick="insertQuickQuery('查询今天的截图记录')">
                            <i data-lucide="plus"></i>
                            查询截图记录
                        </button>
                        <button class="btn btn-outline" onclick="insertQuickQuery('分析我的应用使用情况')">
                            <i data-lucide="brain"></i>
                            应用分析
                        </button>
                        <button class="btn btn-outline" onclick="insertQuickQuery('搜索包含特定内容的截图')">
                            <i data-lucide="search"></i>
                            内容搜索
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages List -->
            <div class="messages-list" id="messagesList" style="display: none;"></div>
        </div>
        
        <div class="thinking-indicator" id="thinkingIndicator" style="display: none;">
            <div class="thinking-avatar">
                <i data-lucide="bot"></i>
            </div>
            <div class="thinking-content">
                <div class="thinking-text" id="thinkingText">正在思考</div>
                <div class="thinking-dots">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>
        
        <!-- 保持原有的loading指示器以兼容性 -->
        <div class="loading" id="loadingIndicator">
            <div class="message-avatar" style="background: var(--accent); color: var(--accent-foreground);">
                <i data-lucide="bot"></i>
            </div>
            <span>正在思考<span class="loading-dots"></span></span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <form class="chat-input-form" id="chatForm">
                    <div class="input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="询问 LifeTrace 助手..." 
                            rows="1"
                            required
                        ></textarea>
                        <button type="submit" class="send-button" id="sendButton">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>
                                <path d="m21.854 2.147-10.94 10.939"></path>
                            </svg>
                        </button>
                    </div>
                </form>
                

            </div>
        </div>
    </main>
    
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const thinkingIndicator = document.getElementById('thinkingIndicator');
        const thinkingText = document.getElementById('thinkingText');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const messagesList = document.getElementById('messagesList');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        // 思考状态控制函数 - 整合到消息流中
        let thinkingMessageDiv = null;
        
        function showThinking(text = '正在思考') {
            // 隐藏欢迎屏幕，显示消息列表
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
            }
            
            // 创建思考消息元素
            thinkingMessageDiv = document.createElement('div');
            thinkingMessageDiv.className = 'thinking-message';
            thinkingMessageDiv.innerHTML = `
                <div class="message-avatar" style="background: transparent; color: var(--muted-foreground);">
                    <i data-lucide="bot"></i>
                </div>
                <div class="message-card">
                    <div class="thinking-indicator">
                        <div class="thinking-content">
                            <div class="thinking-text">${text}</div>
                            <div class="thinking-dots">
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到消息列表
            messagesList.appendChild(thinkingMessageDiv);
            
            // 使用requestAnimationFrame确保DOM更新后再添加show类
            requestAnimationFrame(() => {
                thinkingMessageDiv.classList.add('show');
            });
            
            // 注意：不在这里滚动，让消息发送后的统一滚动逻辑处理
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function hideThinking() {
            if (thinkingMessageDiv) {
                thinkingMessageDiv.classList.remove('show');
                // 等待动画完成后移除元素
                setTimeout(() => {
                    if (thinkingMessageDiv && thinkingMessageDiv.parentNode) {
                        thinkingMessageDiv.parentNode.removeChild(thinkingMessageDiv);
                        thinkingMessageDiv = null;
                    }
                }, 300);
            }
        }
        
        function updateThinkingText(text) {
            if (thinkingMessageDiv) {
                const textElement = thinkingMessageDiv.querySelector('.thinking-text');
                if (textElement) {
                    textElement.textContent = text;
                }
            }
        }
        
        // 轻量级会话上下文：设置与历史存储键
        const SETTINGS_KEY = 'lifetrace_chat_settings';
        const HISTORY_KEY = 'lifetrace_chat_history';

        // 加载设置
        function loadSettings() {
            try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; } catch { return {}; }
        }
        function getSetting(key, defVal) {
            const s = loadSettings();
            return (s && s[key] !== undefined) ? s[key] : defVal;
        }

        // 历史读写
        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch { return []; }
        }
        function saveHistory(history) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }
        function pushHistory(role, content) {
            const h = loadHistory();
            h.push({ role, content, time: Date.now() });
            // 限制最大保存条数，防止无限增长（软上限）
            const maxSaved = 200;
            if (h.length > maxSaved) h.splice(0, h.length - maxSaved);
            saveHistory(h);
        }
        function clearHistory() {
            localStorage.removeItem(HISTORY_KEY);
        }
        function clearHistoryUI() {
            messagesList.innerHTML = '';
            welcomeScreen.style.display = '';
            messagesList.style.display = 'none';
            chatMessages.scrollTop = 0;
        }

        // 构建带K条历史的提示
        function buildPromptWithHistory(currentMessage) {
            const enabled = getSetting('localHistory', true);
            if (!enabled) return currentMessage;
            const K = getSetting('historyLimit', 6); // 若未在设置中配置，则默认6条
            const history = loadHistory();
            if (!history.length) return currentMessage;
            const tail = history.slice(-K);
            const ctx = tail.map(m => `${m.role === 'user' ? '用户' : '助手'}: ${m.content}`).join('\n');
            return `【对话上下文】\n${ctx}\n\n【当前问题】\n用户: ${currentMessage}\n\n请仅回答【当前问题】，必要时参考【对话上下文】。`;
        }
        
        // 处理截图ID链接
        function processScreenshotLinks(content) {
            // 匹配 [截图ID: 数字-数字] 格式（范围）
            const rangePattern = /\[截图ID:\s*(\d+)-(\d+)\]/g;
            content = content.replace(rangePattern, function(match, startId, endId) {
                const start = parseInt(startId);
                const end = parseInt(endId);
                const ids = [];
                for (let i = start; i <= end; i++) {
                    ids.push(i);
                }
                const thumbnails = ids.map(id => 
                    `<div class="screenshot-thumbnail" style="display: inline-block; margin: 2px; padding: 4px 8px; background: #f8f9fa; border: 1px solid #4a5568; border-radius: 4px; cursor: pointer; transition: all 0.2s; min-width: 50px; max-width: 80px; text-align: center;" onclick="openScreenshotModal(${id})" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                        <i data-lucide="image" style="width: 12px; height: 12px; margin-right: 3px; vertical-align: middle;"></i>
                        <span style="color: #4a5568; font-size: 12px; vertical-align: middle;">${id}</span>
                    </div>`
                ).join('');
                return `<div class="screenshot-gallery" style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
                    <div style="margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #4a5568;">截图范围 ${startId}-${endId}:</div>
                    ${thumbnails}
                </div>`;
            });
            
            // 匹配 [截图ID: 数字] 格式（单个）
            const singlePattern = /\[截图ID:\s*(\d+)\]/g;
            content = content.replace(singlePattern, function(match, screenshotId) {
                return `<div class="screenshot-thumbnail" style="display: inline-block; margin: 3px; padding: 5px 10px; background: #f8f9fa; border: 1px solid #4a5568; border-radius: 4px; cursor: pointer; transition: all 0.2s; min-width: 60px; max-width: 100px; text-align: center;" onclick="openScreenshotModal(${screenshotId})" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                    <i data-lucide="image" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"></i>
                    <span style="color: #4a5568; font-size: 13px; vertical-align: middle;">截图 ${screenshotId}</span>
                </div>`;
            });
            
            // 匹配 [截图ID: 数字, 数字, 数字] 格式（多个）
            const multiplePattern = /\[截图ID:\s*([\d,\s]+)\]/g;
            content = content.replace(multiplePattern, function(match, screenshotIds) {
                const ids = screenshotIds.split(',').map(id => id.trim()).filter(id => id);
                const thumbnails = ids.map(id => 
                    `<div class="screenshot-thumbnail" style="display: inline-block; margin: 2px; padding: 4px 8px; background: #f8f9fa; border: 1px solid #4a5568; border-radius: 4px; cursor: pointer; transition: all 0.2s; min-width: 50px; max-width: 80px; text-align: center;" onclick="openScreenshotModal(${id})" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                        <i data-lucide="image" style="width: 12px; height: 12px; margin-right: 3px; vertical-align: middle;"></i>
                        <span style="color: #4a5568; font-size: 12px; vertical-align: middle;">${id}</span>
                    </div>`
                ).join('');
                return `<div class="screenshot-gallery" style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
                    <div style="margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #4a5568;">相关截图:</div>
                    ${thumbnails}
                </div>`;
            });
            
            return content;
        }
        

        
        // 初始化图标
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            // 按设置恢复主题
            const s = loadSettings();
            const shouldDark = !!s.darkMode;
            if (shouldDark) {
                document.documentElement.classList.add('dark');
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', 'sun');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }

            // 初始化面板切换功能
            initPanelSwitching();
        });

        // 面板切换功能 - 新的三列布局
        let currentPanel = null;
        
        function initPanelSwitching() {
            const navIconBtns = document.querySelectorAll('.nav-icon-btn');
            const contentPanels = document.querySelectorAll('.content-panel');
            const middleContentArea = document.getElementById('middleContent');

            // 图标按钮点击事件
            navIconBtns.forEach(button => {
                button.addEventListener('click', function() {
                    const panelId = this.getAttribute('data-panel');
                    
                    // 如果点击的是当前已打开的面板，则关闭
                    if (currentPanel === panelId && middleContentArea.classList.contains('expanded')) {
                        closePanel();
                    } else {
                        openPanel(panelId);
                    }
                });
            });
        }
        
        function openPanel(panelId) {
            const navIconBtns = document.querySelectorAll('.nav-icon-btn');
            const contentPanels = document.querySelectorAll('.content-panel');
            const middleContentArea = document.getElementById('middleContent');
            
            // 移除所有激活状态
            navIconBtns.forEach(btn => btn.classList.remove('active'));
            contentPanels.forEach(panel => panel.classList.remove('active'));
            
            // 激活当前图标
            const activeBtn = document.querySelector(`.nav-icon-btn[data-panel="${panelId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // 显示目标面板
            const targetPanel = document.getElementById(panelId + '-content');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            // 展开中间区域
            middleContentArea.classList.add('expanded');
            currentPanel = panelId;
            
            // 如果是事件面板，重新加载数据
            if (panelId === 'events') {
                setTimeout(() => {
                    loadEvents();
                }, 100);
            }
        }
        
        function closePanel() {
            const navIconBtns = document.querySelectorAll('.nav-icon-btn');
            const contentPanels = document.querySelectorAll('.content-panel');
            const middleContentArea = document.getElementById('middleContent');
            
            // 移除所有激活状态
            navIconBtns.forEach(btn => btn.classList.remove('active'));
            contentPanels.forEach(panel => panel.classList.remove('active'));
            
            // 收起中间区域
            middleContentArea.classList.remove('expanded');
            currentPanel = null;
        }
        
        // 主题切换
        let isDark = false;
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                isDark = !isDark;
                document.documentElement.classList.toggle('dark', isDark);
                
                // 更新图标
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            });
        }
        
        // 快速查询功能
        function insertQuickQuery(query) {
            chatInput.value = query;
            chatInput.focus();
        }
        
        // 自动调整输入框高度
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // 支持Enter发送（不需要Ctrl）
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // 添加消息到聊天界面
        function addMessage(content, isUser = false, timestamp = null) {
            // 隐藏欢迎屏幕，显示消息列表
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            // 对于AI回复，检测并渲染Markdown
            let processedContent = content;
            if (!isUser && typeof marked !== 'undefined') {
                // 检测是否包含Markdown语法
                const hasMarkdown = /[#*`_\[\]\(\)\-\+]|\n\n/.test(content);
                if (hasMarkdown) {
                    processedContent = marked.parse(content);
                }
            }
            
            // 处理截图ID链接（仅对AI回复）
            if (!isUser) {
                processedContent = processScreenshotLinks(processedContent);
            }
            
            const avatarContent = isUser ? 'U' : '<i data-lucide="bot"></i>';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-card">
                    <div class="message-content">${processedContent}</div>
                </div>
            `;
            
            messagesList.appendChild(messageDiv);
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 不再自动滚动到底部，保持用户消息居中显示
        }
        
        // 显示错误消息
        function showError(message) {
            // 隐藏欢迎屏幕，显示消息列表
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message assistant';
            errorDiv.innerHTML = `
                <div class="message-avatar" style="background: var(--destructive); color: var(--destructive-foreground);">
                    <i data-lucide="alert-circle"></i>
                </div>
                <div class="message-card" style="border-color: var(--destructive); background: var(--destructive); color: var(--destructive-foreground);">
                    <div class="message-content">${message}</div>
                </div>
            `;
            
            messagesList.appendChild(errorDiv);
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 错误消息不自动滚动，保持当前位置
        }
        
        // 处理表单提交（流式版本）
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            // 添加用户消息到UI与本地历史
            addMessage(message, true);
            pushHistory('user', message);
            
            // 滚动到最后一条用户消息，让其显示在可见区域的最上方，但留出10px空隙
            setTimeout(() => {
                const userMessages = messagesList.querySelectorAll('.message.user');
                if (userMessages.length > 0) {
                    const lastUserMessage = userMessages[userMessages.length - 1];
                    const chatMessagesContainer = document.querySelector('.chat-messages');
                    const messageRect = lastUserMessage.getBoundingClientRect();
                    const containerRect = chatMessagesContainer.getBoundingClientRect();
                    
                    // 计算需要滚动的距离，留出10px空隙
                    const targetScrollTop = chatMessagesContainer.scrollTop + messageRect.top - containerRect.top - 10;
                    
                    chatMessagesContainer.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }, 100);
            
            // 清空输入框并禁用
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendButton.disabled = true;
            
            // 使用新的思考指示器
            showThinking('正在分析您的问题');
            
            // 保持原有的loading指示器以兼容性（隐藏状态）
            loadingIndicator.style.display = 'none';
            
            // 组装带有最近K条历史的提示
            const payloadMessage = buildPromptWithHistory(message);
            
            // 创建AI消息容器
            let aiMessageDiv = null;
            let aiContentDiv = null;
            let fullResponse = '';
            
            function createAIMessage() {
                // 隐藏欢迎屏幕，显示消息列表
                if (welcomeScreen.style.display !== 'none') {
                    welcomeScreen.style.display = 'none';
                    messagesList.style.display = 'flex';
                }
                
                aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message assistant';
                
                aiMessageDiv.innerHTML = `
                    <div class="message-avatar"><i data-lucide="bot"></i></div>
                    <div class="message-card">
                        <div class="message-content"></div>
                    </div>
                `;
                
                messagesList.appendChild(aiMessageDiv);
                aiContentDiv = aiMessageDiv.querySelector('.message-content');
                
                // 重新创建图标
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            
            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: payloadMessage })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 创建AI消息容器
                createAIMessage();
                
                // 更新思考状态为正在生成回复
                updateThinkingText('正在生成回复');
                
                // 读取流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // 第一次接收到数据时隐藏思考指示器
                    if (fullResponse === '') {
                        hideThinking();
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    fullResponse += chunk;
                    
                    // 实时更新显示内容
                    if (aiContentDiv) {
                        // 检测并渲染Markdown
                        let processedContent = fullResponse;
                        if (typeof marked !== 'undefined') {
                            const hasMarkdown = /[#*`_\[\]\(\)\-\+]|\n\n/.test(fullResponse);
                            if (hasMarkdown) {
                                processedContent = marked.parse(fullResponse);
                            }
                        }
                        aiContentDiv.innerHTML = processedContent;
                        
                        // AI回复完成后不自动滚动，保持用户消息居中
                    }
                }
                
                // 流式输出结束后，重新处理截图链接
                if (aiContentDiv && fullResponse) {
                    // 重新处理截图链接
                    const processedContent = processScreenshotLinks(fullResponse);
                    
                    // 检测并渲染Markdown
                    let finalContent = processedContent;
                    if (typeof marked !== 'undefined') {
                        const hasMarkdown = /[#*`_\[\]\(\)\-\+]|\n\n/.test(processedContent);
                        if (hasMarkdown) {
                            finalContent = marked.parse(processedContent);
                        }
                    }
                    
                    aiContentDiv.innerHTML = finalContent;
                    
                    // 重新创建图标
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
                
                // 保存完整回复到历史
                if (fullResponse) {
                    pushHistory('assistant', fullResponse);
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                hideThinking(); // 确保在错误时隐藏思考指示器
                showError('抱歉，发生了错误：' + error.message);
            } finally {
                sendButton.disabled = false;
                hideThinking(); // 确保思考指示器被隐藏
                loadingIndicator.style.display = 'none';
                chatInput.focus();
            }
        });
        
        // 新对话按钮功能
        const newChatBtn = document.getElementById('newChatBtn');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', async function() {
                try {
                    // 调用后端API创建新对话
                    const response = await fetch('/api/chat/new', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('新对话创建成功:', result);
                        
                        // 清除本地历史记录
                        clearHistory();
                        
                        // 重置界面状态
                        clearHistoryUI();
                        
                        // 聚焦输入框
                        chatInput.focus();
                        
                        // 添加平滑过渡效果
                        messagesList.style.opacity = '0';
                        setTimeout(() => {
                            messagesList.style.opacity = '1';
                        }, 150);
                        
                        // 可选：显示成功提示
                        // showMessage('新对话已开始', 'success');
                    } else {
                        console.error('创建新对话失败:', response.statusText);
                        showError('创建新对话失败，请稍后重试');
                    }
                } catch (error) {
                    console.error('创建新对话时发生错误:', error);
                    showError('创建新对话时发生错误：' + error.message);
                }
            });
        }

        // 页面加载完成后：回放历史并聚焦输入框
        window.addEventListener('load', function() {
            // 回放历史
            const history = loadHistory();
            if (history.length) {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
                history.forEach(m => {
                    addMessage(m.content, m.role === 'user');
                });
            }
            chatInput.focus();
        });

        // 监听来自设置页的清除历史操作
        window.addEventListener('storage', (e) => {
            if (e.key === HISTORY_KEY) {
                if (!e.newValue || e.newValue === '[]') {
                    clearHistoryUI();
                }
            }
            if (e.key === SETTINGS_KEY) {
                // 立即应用暗色模式变更
                try {
                    const s = JSON.parse(e.newValue || '{}');
                    const dm = !!(s && s.darkMode);
                    document.documentElement.classList.toggle('dark', dm);
                    if (themeIcon) {
                        themeIcon.setAttribute('data-lucide', dm ? 'sun' : 'moon');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                } catch {}
            }
        });

        // 截图预览功能
        let currentScreenshotId = null;
        let availableScreenshotIds = [];
        
        function openScreenshotModal(screenshotId) {
            const modal = document.getElementById('screenshotModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalImage = document.getElementById('modalImage');
            const modalLoading = document.getElementById('modalLoading');
            const modalError = document.getElementById('modalError');
            
            // 设置当前截图ID
            currentScreenshotId = parseInt(screenshotId);
            
            // 获取所有可用的截图ID
            updateAvailableScreenshotIds();
            
            // 显示弹窗
            modal.style.display = 'block';
            modalTitle.textContent = `截图 ${screenshotId}`;
            
            // 更新导航按钮状态
            updateNavigationButtons();
            
            // 显示加载状态
            modalLoading.style.display = 'block';
            modalImage.style.display = 'none';
            modalError.style.display = 'none';
            
            // 加载图片
            loadScreenshotImage(screenshotId);
        }
        
        function loadScreenshotImage(screenshotId) {
            const modalImage = document.getElementById('modalImage');
            const modalLoading = document.getElementById('modalLoading');
            const modalError = document.getElementById('modalError');
            const modalTime = document.getElementById('modalTime');
            
            // 显示加载状态
            modalLoading.style.display = 'block';
            modalImage.style.display = 'none';
            modalError.style.display = 'none';
            modalTime.textContent = '';
            
            // 获取截图详细信息
            fetch(`/api/screenshots/${screenshotId}`)
                .then(response => response.json())
                .then(data => {
                    // 更新时间显示
                    if (data.created_at) {
                        const time = new Date(data.created_at).toLocaleString('zh-CN');
                        modalTime.textContent = time;
                    }
                })
                .catch(error => {
                    console.error('获取截图信息失败:', error);
                });
            
            const img = new Image();
            img.onload = function() {
                modalImage.src = this.src;
                modalLoading.style.display = 'none';
                modalImage.style.display = 'block';
                modalError.style.display = 'none';
                // 重新创建图标
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            };
            img.onerror = function() {
                modalLoading.style.display = 'none';
                modalError.style.display = 'block';
                modalImage.style.display = 'none';
                // 重新创建图标
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            };
            img.src = `/api/screenshots/${screenshotId}/image`;
        }
        
        function updateAvailableScreenshotIds() {
            // 从页面中提取所有截图ID，并获取完整范围
            const screenshotElements = document.querySelectorAll('.screenshot-thumbnail');
            const ids = new Set();
            
            screenshotElements.forEach(element => {
                const onclick = element.getAttribute('onclick');
                if (onclick) {
                    const match = onclick.match(/openScreenshotModal\((\d+)\)/);
                    if (match) {
                        ids.add(parseInt(match[1]));
                    }
                }
            });
            
            // 如果有截图ID，创建从0到最大ID的完整范围
            if (ids.size > 0) {
                const maxId = Math.max(...Array.from(ids));
                availableScreenshotIds = [];
                for (let i = 0; i <= maxId; i++) {
                    availableScreenshotIds.push(i);
                }
            } else {
                availableScreenshotIds = [];
            }
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevScreenshotBtn');
            const nextBtn = document.getElementById('nextScreenshotBtn');
            
            if (!prevBtn || !nextBtn) return;
            
            const currentIndex = availableScreenshotIds.indexOf(currentScreenshotId);
            
            // 更新按钮状态
            prevBtn.style.opacity = currentIndex > 0 ? '1' : '0.3';
            prevBtn.style.cursor = currentIndex > 0 ? 'pointer' : 'not-allowed';
            
            nextBtn.style.opacity = currentIndex < availableScreenshotIds.length - 1 ? '1' : '0.3';
            nextBtn.style.cursor = currentIndex < availableScreenshotIds.length - 1 ? 'pointer' : 'not-allowed';
        }
        
        function navigateScreenshot(direction) {
            const currentIndex = availableScreenshotIds.indexOf(currentScreenshotId);
            let newIndex;
            
            if (direction === 'prev' && currentIndex > 0) {
                newIndex = currentIndex - 1;
            } else if (direction === 'next' && currentIndex < availableScreenshotIds.length - 1) {
                newIndex = currentIndex + 1;
            } else {
                return; // 无法导航
            }
            
            const newScreenshotId = availableScreenshotIds[newIndex];
            currentScreenshotId = newScreenshotId;
            
            // 更新标题
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.textContent = `截图 ${newScreenshotId}`;
            
            // 更新导航按钮状态
            updateNavigationButtons();
            
            // 加载新图片
            loadScreenshotImage(newScreenshotId);
        }
        
        function closeScreenshotModal() {
            const modal = document.getElementById('screenshotModal');
            modal.style.display = 'none';
            currentScreenshotId = null;
            availableScreenshotIds = [];
        }
        
        // 点击弹窗外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('screenshotModal');
            if (event.target === modal) {
                closeScreenshotModal();
            }
        }
        
        // ESC键关闭弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeScreenshotModal();
            } else if (event.key === 'ArrowLeft') {
                navigateScreenshot('prev');
            } else if (event.key === 'ArrowRight') {
                navigateScreenshot('next');
            }
        });

        // Events 相关JavaScript代码
        let eventsCurrentPage = 1;
        let eventsTotalPages = 1;
        let eventsCurrentEvents = [];
        const eventsPageSize = 10;

        // 初始化Events页面
        document.addEventListener('DOMContentLoaded', function() {
            loadEvents();
            setupEventsListeners();
        });

        // 设置Events事件监听器
        function setupEventsListeners() {
            // 搜索表单提交
            document.getElementById('eventsSearchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                eventsCurrentPage = 1;
                loadEvents();
            });

            // 分页按钮
            document.getElementById('eventsPrevPage').addEventListener('click', function() {
                if (eventsCurrentPage > 1) {
                    eventsCurrentPage--;
                    loadEvents();
                }
            });

            document.getElementById('eventsNextPage').addEventListener('click', function() {
                if (eventsCurrentPage < eventsTotalPages) {
                    eventsCurrentPage++;
                    loadEvents();
                }
            });
        }

        // 加载事件数据
        async function loadEvents() {
            console.log('开始加载事件数据...');
            const container = document.getElementById('eventsTimelineContainer');
            const stats = document.getElementById('eventsTimelineStats');
            
            // 显示加载状态
            container.innerHTML = '<div class="events-loading">正在加载事件数据</div>';
            stats.textContent = '加载中...';

            try {
                // 获取搜索参数
                const startDate = document.getElementById('eventsStartDate').value;
                const endDate = document.getElementById('eventsEndDate').value;
                const appName = document.getElementById('eventsAppName').value;

                // 构建查询参数
                const params = new URLSearchParams({
                    limit: eventsPageSize,
                    offset: (eventsCurrentPage - 1) * eventsPageSize
                });

                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (appName) params.append('app_name', appName);

                console.log('请求参数:', params.toString());

                const response = await fetch(`/api/events?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('获取到事件数据:', data);

                // API直接返回事件数组，不是包装对象
                eventsCurrentEvents = Array.isArray(data) ? data : [];
                
                // 计算总页数（简单估算，因为API没有返回总数）
                eventsTotalPages = Math.max(1, Math.ceil(eventsCurrentEvents.length / eventsPageSize));

                // 更新统计信息
                const totalEvents = eventsCurrentEvents.length;
                stats.textContent = `共 ${totalEvents} 个事件，第 ${eventsCurrentPage}/${eventsTotalPages} 页`;

                // 渲染时间轴
                renderEventsTimeline(eventsCurrentEvents);

                // 更新分页
                updateEventsPagination();

            } catch (error) {
                console.error('加载事件数据失败:', error);
                container.innerHTML = `
                    <div class="events-empty-state">
                        <p>加载事件数据失败</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
                stats.textContent = '加载失败';
            }
        }

        // 渲染时间轴
        function renderEventsTimeline(events) {
            console.log('renderEventsTimeline被调用，事件数量:', events.length);
            const container = document.getElementById('eventsTimelineContainer');
            
            if (events.length === 0) {
                console.log('没有事件数据，显示空状态');
                container.innerHTML = `
                    <div class="events-empty-state">
                        <p>暂无事件数据</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">尝试调整搜索条件或检查录制服务是否正常运行</p>
                    </div>
                `;
                return;
            }

            console.log('开始创建时间轴元素');
            const timeline = document.createElement('div');
            timeline.className = 'events-timeline';

            // 按日期分组事件
            const eventsByDate = groupEventsByDate(events);
            
            // 为每个日期组创建内容
            Object.keys(eventsByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const dateGroup = document.createElement('div');
                dateGroup.className = 'events-date-group';
                
                // 创建日期标题
                const dateHeader = document.createElement('div');
                dateHeader.className = 'events-date-header';
                
                const dateTitle = document.createElement('h3');
                dateTitle.className = 'events-date-title';
                
                // 格式化日期显示
                const dateObj = new Date(date);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let dateText;
                if (dateObj.toDateString() === today.toDateString()) {
                    dateText = '今天';
                } else if (dateObj.toDateString() === yesterday.toDateString()) {
                    dateText = '昨天';
                } else {
                    dateText = dateObj.toLocaleDateString('zh-CN', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                }
                
                dateTitle.innerHTML = `
                    <svg class="events-date-icon" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4.75 0a.75.75 0 01.75.75V2h5V.75a.75.75 0 011.5 0V2h1.25c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0113.25 16H2.75A1.75 1.75 0 011 14.25V3.75C1 2.784 1.784 2 2.75 2H4V.75A.75.75 0 014.75 0zm0 3.5h8.5a.25.25 0 01.25.25V6H2V3.75a.25.25 0 01.25-.25h2.5zm-2.25 4v6.75c0 .138.112.25.25.25h10.5a.25.25 0 00.25-.25V7.5H2.5z"/>
                    </svg>
                    ${dateText}
                `;
                
                dateHeader.appendChild(dateTitle);
                dateGroup.appendChild(dateHeader);
                
                // 添加该日期的所有事件
                eventsByDate[date].forEach((event, index) => {
                    console.log(`创建事件项 ${index + 1}/${eventsByDate[date].length}:`, event);
                    const item = createEventsTimelineItem(event);
                    dateGroup.appendChild(item);
                });
                
                timeline.appendChild(dateGroup);
            });

            console.log('清空容器并添加时间轴');
            container.innerHTML = '';
            container.appendChild(timeline);
            console.log('时间轴渲染完成');
        }

        // 按日期分组事件
        function groupEventsByDate(events) {
            const groups = {};
            
            events.forEach(event => {
                const date = new Date(event.start_time).toDateString();
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(event);
            });
            
            return groups;
        }

        // 创建时间轴项目
        function createEventsTimelineItem(event) {
            const item = document.createElement('div');
            item.className = 'events-timeline-item';

            const startTime = new Date(event.start_time);
            const endTime = event.end_time ? new Date(event.end_time) : null;
            const duration = endTime ? Math.round((endTime - startTime) / 1000 / 60) : null;

            // 添加应用图标和更好的布局
            const appName = event.app_name || '未知应用';
            const windowTitle = event.window_title || '未知窗口';
            
            item.innerHTML = `
                <div class="events-event-header">
                    <div class="events-event-title">
                        <div class="events-app-info">
                            <span class="events-app-name">${appName}</span>
                            <span class="events-window-title">${windowTitle}</span>
                        </div>
                    </div>
                    <div class="events-event-time">
                        <div class="events-time-text">${formatEventsTime(startTime)}</div>
                        ${endTime ? `<div class="events-event-duration">持续 ${duration} 分钟</div>` : '<div class="events-event-status">进行中</div>'}
                    </div>
                </div>
                <div class="events-screenshots-preview" id="events-screenshots-${event.id}">
                    <div class="events-loading">正在加载截图...</div>
                </div>
            `;

            // 异步加载截图
            setTimeout(() => {
                loadEventsScreenshots(event.id);
            }, 10);

            return item;
        }

        // 加载事件截图
        async function loadEventsScreenshots(eventId) {
            const container = document.getElementById(`events-screenshots-${eventId}`);
            
            if (!container) {
                console.error(`找不到截图容器: events-screenshots-${eventId}`);
                return;
            }
            
            try {
                console.log(`开始加载事件 ${eventId} 的截图`);
                const response = await fetch(`/api/events/${eventId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const eventDetail = await response.json();
                console.log(`事件 ${eventId} 详情:`, eventDetail);
                const screenshots = eventDetail.screenshots || [];
                
                if (screenshots.length === 0) {
                    if (container) {
                        container.innerHTML = '<div class="events-empty-state" style="padding: 1rem; font-size: 0.8rem;">暂无截图</div>';
                    }
                    return;
                }

                // 创建截图网格
                const grid = document.createElement('div');
                grid.className = 'events-screenshots-grid';

                screenshots.slice(0, 6).forEach((screenshot, index) => {
                    const img = document.createElement('img');
                    img.src = `/api/screenshots/${screenshot.id}/image`;
                    img.className = 'events-screenshot-thumb';
                    img.alt = `截图 ${index + 1}`;
                    img.onclick = () => openScreenshotModal(screenshot.id, screenshots, index);
                    
                    img.onerror = function() {
                        this.style.display = 'none';
                    };
                    
                    grid.appendChild(img);
                });

                if (screenshots.length > 6) {
                    const moreDiv = document.createElement('div');
                    moreDiv.style.cssText = 'display: flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 4px; font-size: 0.7rem; color: #666; cursor: pointer;';
                    moreDiv.textContent = `+${screenshots.length - 6}`;
                    moreDiv.onclick = () => openScreenshotModal(screenshots[6].id, screenshots, 6);
                    grid.appendChild(moreDiv);
                }

                if (container) {
                    container.innerHTML = '';
                    container.appendChild(grid);
                }

            } catch (error) {
                console.error(`加载事件 ${eventId} 截图失败:`, error);
                if (container) {
                    container.innerHTML = '<div class="events-empty-state" style="padding: 1rem; font-size: 0.8rem; color: #e74c3c;">截图加载失败</div>';
                }
            }
        }

        // 更新分页
        function updateEventsPagination() {
            const pagination = document.getElementById('eventsPagination');
            const pageInfo = document.getElementById('eventsPageInfo');
            const prevBtn = document.getElementById('eventsPrevPage');
            const nextBtn = document.getElementById('eventsNextPage');

            if (eventsTotalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            pageInfo.textContent = `第 ${eventsCurrentPage} 页，共 ${eventsTotalPages} 页`;
            
            prevBtn.disabled = eventsCurrentPage <= 1;
            nextBtn.disabled = eventsCurrentPage >= eventsTotalPages;
        }

        // 格式化时间
        function formatEventsTime(date) {
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>

    <!-- 截图预览弹窗 -->
    <div id="screenshotModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="position: relative; margin: 2% auto; padding: 0; width: 95%; max-width: 1200px; background-color: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div class="modal-header" style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h3 id="modalTitle" style="margin: 0; color: #4a5568; font-size: 18px;">截图预览</h3>
                    <span id="modalTime" style="color: #666; font-size: 14px; font-weight: normal;"></span>
                </div>
                <span class="close" onclick="closeScreenshotModal()" style="font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1;" onmouseover="this.style.color='#4a5568'" onmouseout="this.style.color='#aaa'">&times;</span>
            </div>
            <div class="modal-body" style="position: relative; padding: 20px; text-align: center;">
                <!-- 左侧导航按钮 -->
                <button id="prevScreenshotBtn" onclick="navigateScreenshot('prev')" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='rgba(0,0,0,0.7)'" onmouseout="this.style.background='rgba(0,0,0,0.5)'">
                    <i data-lucide="chevron-left" style="width: 22px; height: 22px;"></i>
                </button>
                
                <!-- 右侧导航按钮 -->
                <button id="nextScreenshotBtn" onclick="navigateScreenshot('next')" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='rgba(0,0,0,0.7)'" onmouseout="this.style.background='rgba(0,0,0,0.5)'">
                    <i data-lucide="chevron-right" style="width: 22px; height: 22px;"></i>
                </button>
                
                <div id="modalLoading" style="display: none; color: #666; font-size: 16px; padding: 40px;">
                    <i data-lucide="loader-2" style="width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; animation: spin 1s linear infinite;"></i>
                    加载中...
                </div>
                <img id="modalImage" style="max-width: 100%; max-height: 80vh; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);" />
                <div id="modalError" style="display: none; color: #e74c3c; font-size: 16px; padding: 40px;">
                    <i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-right: 8px; vertical-align: middle;"></i>
                    图像加载失败
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>

        </div> <!-- 关闭 right-chat-area -->
    </div> <!-- 关闭 main-layout -->

    <script>
        // App Usage Analytics JavaScript
        let appUsageChart = null;
        let hourlyUsageChart = null;

        // 格式化时间
        function formatTime(minutes) {
            if (minutes < 60) {
                return `${Math.round(minutes)}分钟`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return mins > 0 ? `${hours}小时${mins}分钟` : `${hours}小时`;
            }
        }

        // 获取应用使用统计数据
        async function fetchAppUsageStats() {
            try {
                // 由于已经移除了时间范围过滤器，使用默认值
                const days = 7;
                
                const params = new URLSearchParams({
                    days: days
                });

                const response = await fetch(`/api/app-usage-stats?${params}`);
                if (!response.ok) {
                    throw new Error('获取数据失败');
                }
                
                const data = await response.json();
                updateAppUsageStats(data);
                updateAppUsageCharts(data);
            } catch (error) {
                console.error('获取应用使用统计数据失败:', error);
                showAppUsageError('获取数据失败，请稍后重试');
            }
        }

        // 更新统计卡片
        function updateAppUsageStats(data) {
            document.getElementById('appUsageTotalTime').textContent = 
                (data.total_usage_time / 3600).toFixed(1);
            document.getElementById('appUsageTotalApps').textContent = data.total_apps_used;
        }

        // 更新图表
        function updateAppUsageCharts(data) {
            updateAppUsageChart(data.top_apps_by_time);
            updateHourlyUsageChart(data.hourly_app_distribution);
        }

        // 应用使用时长分布图表
        function updateAppUsageChart(topApps) {
            const ctx = document.getElementById('appUsageChart').getContext('2d');
            
            if (appUsageChart) {
                appUsageChart.destroy();
            }

            const labels = topApps.slice(0, 10).map(app => app.app_name);
            const data = topApps.slice(0, 10).map(app => app.total_time / 3600); // 转换为小时

            // 现代化渐变色彩方案
            const gradientColors = [
                { start: '#667eea', end: '#764ba2' }, // 紫蓝渐变
                { start: '#f093fb', end: '#f5576c' }, // 粉红渐变
                { start: '#4facfe', end: '#00f2fe' }, // 蓝青渐变
                { start: '#43e97b', end: '#38f9d7' }, // 绿青渐变
                { start: '#fa709a', end: '#fee140' }, // 粉黄渐变
                { start: '#a8edea', end: '#fed6e3' }, // 青粉渐变
                { start: '#ff9a9e', end: '#fecfef' }, // 红粉渐变
                { start: '#ffecd2', end: '#fcb69f' }, // 黄橙渐变
                { start: '#a18cd1', end: '#fbc2eb' }, // 紫粉渐变
                { start: '#fad0c4', end: '#ffd1ff' }  // 橙粉渐变
            ];

            // 创建渐变背景
            const backgroundColors = gradientColors.slice(0, labels.length).map(color => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color.start);
                gradient.addColorStop(1, color.end);
                return gradient;
            });

            // 悬停时的边框颜色
            const hoverBorderColors = gradientColors.slice(0, labels.length).map(color => color.start);

            appUsageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverBorderColor: hoverBorderColors,
                        hoverBorderWidth: 3,
                        hoverOffset: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15,
                                font: {
                                    size: 11,
                                    family: "'Inter', 'Segoe UI', sans-serif"
                                },
                                color: 'var(--foreground)',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const dataset = data.datasets[0];
                                            const value = dataset.data[i];
                                            const total = dataset.data.reduce((sum, val) => sum + val, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            
                                            return {
                                                text: `${label} (${percentage}%)`,
                                                fillStyle: gradientColors[i]?.start || '#ccc',
                                                strokeStyle: gradientColors[i]?.start || '#ccc',
                                                lineWidth: 0,
                                                pointStyle: 'circle',
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 6,
                            displayColors: true,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 10,
                            titleFont: {
                                size: 12,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 11
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    const hours = value.toFixed(1);
                                    return [`使用时长: ${hours} 小时`, `占比: ${percentage}%`];
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 800,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // 小时使用分布图表
        function updateHourlyUsageChart(hourlyData) {
            const ctx = document.getElementById('hourlyUsageChart').getContext('2d');
            
            if (hourlyUsageChart) {
                hourlyUsageChart.destroy();
            }

            const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const data = labels.map((_, hour) => {
                if (hourlyData[hour] && typeof hourlyData[hour] === 'object') {
                    const totalSeconds = Object.values(hourlyData[hour]).reduce((sum, duration) => sum + duration, 0);
                    return totalSeconds / 3600;
                }
                return 0;
            });

            // 创建渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
            gradient.addColorStop(0.5, 'rgba(147, 51, 234, 0.6)');
            gradient.addColorStop(1, 'rgba(236, 72, 153, 0.4)');

            hourlyUsageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '使用时长 (小时)',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#f9fafb',
                            bodyColor: '#f3f4f6',
                            borderColor: 'rgba(59, 130, 246, 0.5)',
                            borderWidth: 1,
                            cornerRadius: 6,
                            padding: 12,
                            displayColors: false,
                            titleFont: {
                                size: 12,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 11
                            },
                            callbacks: {
                                title: function(context) {
                                    const hour = context[0].label;
                                    return `${hour} 时段`;
                                },
                                label: function(context) {
                                    const hours = context.parsed.y.toFixed(2);
                                    const minutes = Math.round(context.parsed.y * 60);
                                    
                                    if (hours >= 1) {
                                        return `使用时长: ${hours} 小时`;
                                    } else if (minutes >= 1) {
                                        return `使用时长: ${minutes} 分钟`;
                                    } else {
                                        return `使用时长: ${Math.round(context.parsed.y * 3600)} 秒`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '使用时长 (小时)',
                                color: 'var(--muted-foreground)',
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + 'h';
                                },
                                color: 'var(--muted-foreground)',
                                font: {
                                    size: 9
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.2)',
                                lineWidth: 1,
                                drawBorder: false,
                                drawTicks: false,
                                borderDash: [3, 3],
                                borderDashOffset: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间段',
                                color: 'var(--muted-foreground)',
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: 'var(--muted-foreground)',
                                font: {
                                    size: 8
                                },
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: {
                                display: true,
                                color: 'rgba(148, 163, 184, 0.15)',
                                lineWidth: 1,
                                drawBorder: false,
                                drawTicks: false,
                                borderDash: [2, 4],
                                borderDashOffset: 0
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutCubic'
                    }
                }
            });
        }

        // 显示错误信息
        function showAppUsageError(message) {
            // 可以在这里添加错误显示逻辑
            console.error('App Usage Error:', message);
        }

        // 生成今日总结
        async function generateDailySummary() {
            const summaryContent = document.getElementById('summaryContent');
            const summaryText = document.getElementById('summaryText');
            const summaryLoading = document.getElementById('summaryLoading');
            const generateBtn = document.getElementById('generateSummaryBtn');

            try {
                // 显示加载状态
                summaryContent.style.display = 'block';
                summaryLoading.style.display = 'block';
                summaryText.style.display = 'none';
                generateBtn.disabled = true;
                generateBtn.style.opacity = '0.6';

                // 调用聊天API，模拟用户发送消息
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: '帮我总结一下今天的工作',
                        conversation_id: null
                    })
                });

                if (!response.ok) {
                    throw new Error('生成总结失败');
                }

                // 处理流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let summaryResult = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // 第一次接收到数据时隐藏加载状态
                    if (summaryResult === '') {
                        summaryLoading.style.display = 'none';
                        summaryText.style.display = 'block';
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    console.log('收到数据块:', chunk); // 调试信息
                    summaryResult += chunk;
                    
                    // 实时更新显示内容
                    summaryText.innerHTML = formatSummaryText(summaryResult);
                }

                console.log('最终结果:', summaryResult); // 调试信息
                // 显示结果
                summaryLoading.style.display = 'none';
                summaryText.style.display = 'block';
                summaryText.innerHTML = formatSummaryText(summaryResult);

            } catch (error) {
                console.error('生成总结失败:', error);
                summaryLoading.style.display = 'none';
                summaryText.style.display = 'block';
                summaryText.innerHTML = '<div style="color: #ef4444; text-align: center;">生成总结失败，请稍后重试</div>';
            } finally {
                generateBtn.disabled = false;
                generateBtn.style.opacity = '1';
            }
        }

        // 格式化总结文本
        function formatSummaryText(text) {
            if (!text || text.trim() === '') {
                return '<p style="color: #64748b; text-align: center;">暂无内容</p>';
            }
            
            // 简单的富文本格式化
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // 确保内容被包裹在段落标签中
            if (!formatted.startsWith('<p>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }

        // 事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 添加总结按钮事件监听
            const generateSummaryBtn = document.getElementById('generateSummaryBtn');
            if (generateSummaryBtn) {
                generateSummaryBtn.addEventListener('click', generateDailySummary);
            }

            // 监听标签页切换，当切换到省吾身标签页时加载数据
            const searchTab = document.querySelector('[data-tab="search"]');
            if (searchTab) {
                searchTab.addEventListener('click', function() {
                    // 延迟加载数据，确保DOM已渲染
                    setTimeout(() => {
                        if (document.getElementById('appUsageChart')) {
                            fetchAppUsageStats();
                        }
                    }, 100);
                });
            }
        });
    </script>
</body>
</html>