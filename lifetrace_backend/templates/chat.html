<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeTrace Chat - 智能对话助手</title>
    <!-- Markdown解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            /* Updated color tokens to match v0 chat design */
            --background: oklch(1 0 0);
            --foreground: oklch(0.145 0 0);
            --card: oklch(0.985 0 0);
            --card-foreground: oklch(0.145 0 0);
            --popover: oklch(1 0 0);
            --popover-foreground: oklch(0.145 0 0);
            --primary: oklch(0.145 0 0);
            --primary-foreground: oklch(0.985 0 0);
            --secondary: oklch(0.97 0 0);
            --secondary-foreground: oklch(0.145 0 0);
            --muted: oklch(0.97 0 0);
            --muted-foreground: oklch(0.556 0 0);
            --accent: oklch(0.646 0.222 264.376);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.577 0.245 27.325);
            --destructive-foreground: oklch(0.985 0 0);
            --border: oklch(0.922 0 0);
            --input: oklch(0.985 0 0);
            --ring: oklch(0.646 0.222 264.376);
            --radius: 0.625rem;
        }
        
        .dark {
            /* Updated dark mode tokens for better contrast */
            --background: oklch(0.145 0 0);
            --foreground: oklch(0.985 0 0);
            --card: oklch(0.205 0 0);
            --card-foreground: oklch(0.985 0 0);
            --popover: oklch(0.205 0 0);
            --popover-foreground: oklch(0.985 0 0);
            --primary: oklch(0.985 0 0);
            --primary-foreground: oklch(0.145 0 0);
            --secondary: oklch(0.269 0 0);
            --secondary-foreground: oklch(0.985 0 0);
            --muted: oklch(0.269 0 0);
            --muted-foreground: oklch(0.708 0 0);
            --accent: oklch(0.646 0.222 264.376);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.577 0.245 27.325);
            --destructive-foreground: oklch(0.985 0 0);
            --border: oklch(0.269 0 0);
            --input: oklch(0.205 0 0);
            --ring: oklch(0.646 0.222 264.376);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s, color 0.2s;
        }
        
        /* Header */
        .header {
            border-bottom: 1px solid var(--border);
            background: var(--background);
            backdrop-filter: blur(8px);
            flex-shrink: 0;
        }
        
        .header-content {
            display: flex;
            height: 3.5rem;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-logo {
            display: flex;
            height: 2rem;
            width: 2rem;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            background: var(--primary);
            color: var(--primary-foreground);
        }
        
        .header-title {
            font-weight: 600;
            color: var(--foreground);
            font-size: 1rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            text-decoration: none;
            gap: 0.5rem;
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--foreground);
            padding: 0.5rem;
        }
        
        .btn-ghost:hover {
            background: var(--accent);
            color: var(--accent-foreground);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--foreground);
            border: 1px solid var(--border);
            padding: 0.375rem 0.75rem;
        }
        
        .btn-outline:hover {
            background: var(--accent);
            color: var(--accent-foreground);
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
            padding: 0.375rem 0.75rem;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-icon {
            height: 2rem;
            width: 2rem;
            padding: 0;
        }
        
        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 3.5rem);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-width: 64rem;
            margin: 0 auto;
            width: 100%;
        }
        
        .welcome-screen {
            display: flex;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .welcome-content {
            text-align: center;
            max-width: 32rem;
            margin-bottom: 1.5rem;
        }
        
        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--foreground);
            margin-bottom: 1.5rem;
            line-height: 1.2;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }
        
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            display: flex;
            gap: 0.75rem;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.assistant {
            justify-content: flex-start;
        }
        
        .message-avatar {
            width: 2rem;
            height: 2rem;
            margin-top: 0.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: var(--secondary);
            color: var(--secondary-foreground);
        }
        
        .message.assistant .message-avatar {
            background: var(--accent);
            color: var(--accent-foreground);
        }
        
        .message-card {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: var(--radius);
            word-wrap: break-word;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .message.user .message-card {
            background: var(--primary);
            color: var(--primary-foreground);
        }
        
        .message.assistant .message-card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
        }
        
        .message-content {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--muted-foreground);
            margin-top: 0.5rem;
            display: block;
            opacity: 0.7;
        }
        
        /* Markdown样式 */
        .message-content h1, .message-content h2, .message-content h3,
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 0.5rem 0;
            font-weight: bold;
        }
        
        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.3rem; }
        .message-content h3 { font-size: 1.1rem; }
        
        .message-content p {
            margin: 0.5rem 0;
            line-height: 1.5;
        }
        
        .message-content ul, .message-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .message-content li {
            margin: 0.25rem 0;
        }
        
        .message-content code {
            background-color: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .message-content pre {
            background-color: #f1f5f9;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        .message-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .message-content strong {
            font-weight: bold;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content a {
            color: #667eea;
            text-decoration: none;
        }
        
        .message-content a:hover {
            text-decoration: underline;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .message-content th, .message-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f9fafb;
            font-weight: bold;
        }
        
        /* Input Area */
        .chat-input-container {
            border-top: 1px solid var(--border);
            background: var(--background);
            padding: 1rem;
            flex-shrink: 0;
        }
        
        .input-wrapper {
            max-width: 64rem;
            margin: 0 auto;
        }
        
        .chat-input-form {
            display: flex;
            gap: 0.5rem;
            align-items: end;
        }
        
        .input-container {
            flex: 1;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem 3rem 0.75rem 0.75rem;
            font-size: 0.875rem;
            resize: none;
            min-height: 2.75rem;
            max-height: 7.5rem;
            font-family: inherit;
            background: var(--input);
            color: var(--foreground);
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px var(--ring);
        }
        
        .chat-input::placeholder {
            color: var(--muted-foreground);
        }
        
        .send-button {
            position: absolute;
            right: 0.25rem;
            top: 0.25rem;
            height: 2rem;
            width: 2rem;
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover:not(:disabled) {
            opacity: 0.9;
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .agent-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-style: italic;
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 2rem;
            font-style: italic;
        }
        
        .error-message {
            background: #fee;
            color: #c53030;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border: 1px solid #fed7d7;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .chat-container {
                padding: 0 0.5rem;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <i data-lucide="sparkles"></i>
                </div>
                <span class="header-title">LifeTrace Chat</span>
            </div>
            <div class="header-right">
                <button class="btn btn-ghost btn-icon" id="themeToggle">
                    <i data-lucide="moon" id="themeIcon"></i>
                </button>
                <a href="/" class="btn btn-outline">首页</a>
                <a href="/api/docs" class="btn btn-primary">API文档</a>
            </div>
        </div>
    </header>
    
    <!-- Main Chat Area -->
    <main class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <h1 class="welcome-title">我可以帮您做什么？</h1>
                    <div class="quick-actions">
                        <button class="btn btn-outline" onclick="insertQuickQuery('查询今天的截图记录')">
                            <i data-lucide="plus"></i>
                            查询截图记录
                        </button>
                        <button class="btn btn-outline" onclick="insertQuickQuery('分析我的应用使用情况')">
                            <i data-lucide="sparkles"></i>
                            应用分析
                        </button>
                        <button class="btn btn-outline" onclick="insertQuickQuery('搜索包含特定内容的截图')">
                            <i data-lucide="search"></i>
                            内容搜索
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages List -->
            <div class="messages-list" id="messagesList" style="display: none;"></div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="message-avatar" style="background: var(--accent); color: var(--accent-foreground);">
                <i data-lucide="sparkles"></i>
            </div>
            <span>正在思考<span class="loading-dots"></span></span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <form class="chat-input-form" id="chatForm">
                    <div class="input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="询问 LifeTrace 助手..." 
                            rows="1"
                            required
                        ></textarea>
                        <button type="submit" class="send-button" id="sendButton">
                            <i data-lucide="send"></i>
                        </button>
                    </div>
                </form>
                
                <!-- Agent Selector -->
                <div class="agent-selector">
                    <button class="btn btn-ghost" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        <i data-lucide="sparkles" style="width: 0.75rem; height: 0.75rem;"></i>
                        智能助手
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const messagesList = document.getElementById('messagesList');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        // 轻量级会话上下文：设置与历史存储键
        const SETTINGS_KEY = 'lifetrace_chat_settings';
        const HISTORY_KEY = 'lifetrace_chat_history';

        // 加载设置
        function loadSettings() {
            try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; } catch { return {}; }
        }
        function getSetting(key, defVal) {
            const s = loadSettings();
            return (s && s[key] !== undefined) ? s[key] : defVal;
        }

        // 历史读写
        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch { return []; }
        }
        function saveHistory(history) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }
        function pushHistory(role, content) {
            const h = loadHistory();
            h.push({ role, content, time: Date.now() });
            // 限制最大保存条数，防止无限增长（软上限）
            const maxSaved = 200;
            if (h.length > maxSaved) h.splice(0, h.length - maxSaved);
            saveHistory(h);
        }
        function clearHistoryUI() {
            messagesList.innerHTML = '';
            welcomeScreen.style.display = '';
            messagesList.style.display = 'none';
            chatMessages.scrollTop = 0;
        }

        // 构建带K条历史的提示
        function buildPromptWithHistory(currentMessage) {
            const enabled = getSetting('localHistory', true);
            if (!enabled) return currentMessage;
            const K = getSetting('historyLimit', 6); // 若未在设置中配置，则默认6条
            const history = loadHistory();
            if (!history.length) return currentMessage;
            const tail = history.slice(-K);
            const ctx = tail.map(m => `${m.role === 'user' ? '用户' : '助手'}: ${m.content}`).join('\n');
            return `【对话上下文】\n${ctx}\n\n【当前问题】\n用户: ${currentMessage}\n\n请仅回答【当前问题】，必要时参考【对话上下文】。`;
        }
        
        // 初始化图标
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            // 按设置恢复主题
            const s = loadSettings();
            const shouldDark = !!s.darkMode;
            if (shouldDark) {
                document.documentElement.classList.add('dark');
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', 'sun');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        });
        
        // 主题切换
        let isDark = false;
        themeToggle.addEventListener('click', function() {
            isDark = !isDark;
            document.documentElement.classList.toggle('dark', isDark);
            
            // 更新图标
            themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        // 快速查询功能
        function insertQuickQuery(query) {
            chatInput.value = query;
            chatInput.focus();
        }
        
        // 自动调整输入框高度
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // 支持Enter发送（不需要Ctrl）
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // 添加消息到聊天界面
        function addMessage(content, isUser = false, timestamp = null) {
            // 隐藏欢迎屏幕，显示消息列表
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const time = timestamp || new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // 对于AI回复，检测并渲染Markdown
            let processedContent = content;
            if (!isUser && typeof marked !== 'undefined') {
                // 检测是否包含Markdown语法
                const hasMarkdown = /[#*`_\[\]\(\)\-\+]|\n\n/.test(content);
                if (hasMarkdown) {
                    processedContent = marked.parse(content);
                }
            }
            
            const avatarContent = isUser ? 'U' : '<i data-lucide="sparkles"></i>';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-card">
                    <div class="message-content">${processedContent}</div>
                    <span class="message-time">${time}</span>
                </div>
            `;
            
            messagesList.appendChild(messageDiv);
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 显示错误消息
        function showError(message) {
            // 隐藏欢迎屏幕，显示消息列表
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message assistant';
            errorDiv.innerHTML = `
                <div class="message-avatar" style="background: var(--destructive); color: var(--destructive-foreground);">
                    <i data-lucide="alert-circle"></i>
                </div>
                <div class="message-card" style="border-color: var(--destructive); background: var(--destructive); color: var(--destructive-foreground);">
                    <div class="message-content">${message}</div>
                    <span class="message-time">${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                </div>
            `;
            
            messagesList.appendChild(errorDiv);
            
            // 重新创建图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 处理表单提交
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            // 添加用户消息到UI与本地历史
            addMessage(message, true);
            pushHistory('user', message);
            
            // 清空输入框并禁用
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendButton.disabled = true;
            loadingIndicator.style.display = 'flex';
            
            // 组装带有最近K条历史的提示
            const payloadMessage = buildPromptWithHistory(message);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: payloadMessage })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // 添加AI回复并保存到历史
                addMessage(data.response);
                pushHistory('assistant', data.response);
                
            } catch (error) {
                console.error('Chat error:', error);
                showError('抱歉，发生了错误：' + error.message);
            } finally {
                sendButton.disabled = false;
                loadingIndicator.style.display = 'none';
                chatInput.focus();
            }
        });
        
        // 页面加载完成后：回放历史并聚焦输入框
        window.addEventListener('load', function() {
            // 回放历史
            const history = loadHistory();
            if (history.length) {
                welcomeScreen.style.display = 'none';
                messagesList.style.display = 'flex';
                history.forEach(m => {
                    const ts = m.time ? new Date(m.time).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : null;
                    addMessage(m.content, m.role === 'user', ts);
                });
            }
            chatInput.focus();
        });

        // 监听来自设置页的清除历史操作
        window.addEventListener('storage', (e) => {
            if (e.key === HISTORY_KEY) {
                if (!e.newValue || e.newValue === '[]') {
                    clearHistoryUI();
                }
            }
            if (e.key === SETTINGS_KEY) {
                // 立即应用暗色模式变更
                try {
                    const s = JSON.parse(e.newValue || '{}');
                    const dm = !!(s && s.darkMode);
                    document.documentElement.classList.toggle('dark', dm);
                    if (themeIcon) {
                        themeIcon.setAttribute('data-lucide', dm ? 'sun' : 'moon');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                } catch {}
            }
        });
    </script>
</body>
</html>